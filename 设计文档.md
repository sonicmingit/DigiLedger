# DigiLedger V0.3 产品设计（方案A 简化版）

> 约定 & 范围
>
> * 均摊成本：**按天计算**。
> * 折旧：**不再计算折旧**（仅展示总投入、使用天数、日均成本）。
> * 架构：**前后端分离**。后端 `Spring Boot + MyBatis + MySQL`；前端 `Vue3 + Vite + Element Plus`。
> * 部署：**Docker/Compose 一键启动**（含 MySQL、后端、前端、Nginx 反代）。
> * 接口返回体：统一为 `{ code, data, msg }`，`code=200` 表示成功。
> * 版本：V0.2（在 V0.1 基础上细化到可直接开发）。

---

## 1. 目标与业务概述

### 1.1 产品目标

* 管理个人/家庭/小团队的**数码资产全生命周期**：购买 → 使用 → 维护/配件 → 转售/报废。
* 实时输出**成本均摊**（总投入、使用天数、日均成本）等简化指标。

### 1.2 关键业务要点

* **购买记录**：主购买 + 配件/服务扩展，支持附件（发票/截图）。
* **使用统计**：按天均摊；启用日期至当前/售出/报废。
* **折旧**：不计算折旧，仅展示总投入与日均成本。
* **转售**：记录售出平台、价格、费用、净收入；资产状态联动。
* **统计/报表**：按类别、平台、年份聚合；仪表盘 KPI。
* **导入导出**：CSV 导入资产（含主购买）、列表导出。

---

## 2. 术语与状态机

* 资产（Asset）：一台设备的主档（如：iPhone 14 Pro 256G）。
* 购买（Purchase）：资产的购买行为（主购买 / 配件 / 服务）。
* 使用（Usage）：按天均摊的前提下，可不强制记录小时级使用日志（后续再做）。
* 售出（Sale）：设备交易记录，记价格、费用、净收入、盈亏、平台等。
* 状态（中文）：`使用中`、`已闲置`、`待出售`、`已出售`、`已丢弃`、`心愿`（心愿为单独列表）。

**状态机（资产）**：

* `使用中` ↔ `已闲置` ↔ `待出售` → `已出售`
* 任意 → `已丢弃`
* `已出售/已丢弃` 支持撤销（保留审计日志）。

**心愿单**：独立列表，不参与上述状态流转；心愿条目可一键“转为资产”。

---

## 3. 成本与均摊模型（无折旧）

### 3.1 总投入

```
总投入 total_invest = Σ( purchase.price + purchase.shipping_cost )
  其中 purchase.type ∈ { PRIMARY, ACCESSORY, SERVICE }
```

### 3.2 使用天数（按天法）

```
use_days =
  若状态 ∈ {使用中, 已闲置, 待出售}: days_between(enabled_date, today)
  若状态 = 已出售:                 days_between(enabled_date, sale_date)
  若状态 = 已丢弃:                 days_between(enabled_date, retired_date)
```

> `days_between(a,b)` 为自然日差，含首不含尾；最低为 1，避免除零。

### 3.3 平均日成本（按天均摊）

```
avg_cost_per_day = total_invest / max(use_days, 1)
```

---

## 4. 数据模型（MySQL 8）

### 4.1 表结构（DDL）

```sql
CREATE TABLE sys_setting (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  currency  VARCHAR(10) NOT NULL DEFAULT 'CNY',
  -- 对象存储配置（MinIO/OSS/S3 等兼容接口）
  storage_provider VARCHAR(32) NOT NULL DEFAULT 'minio',  -- minio,s3,aliyun,cos,qiniu,local
  storage_endpoint VARCHAR(255),       -- http://minio:9000 或 OSS 端点
  storage_region   VARCHAR(64),
  storage_bucket   VARCHAR(128) DEFAULT 'digiledger',
  storage_access_key VARCHAR(128),
  storage_secret_key VARCHAR(128),
  storage_base_url VARCHAR(255),       -- 对外访问域名（CDN/反代），用于拼接图片URL
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE device_asset (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(200) NOT NULL,
  category VARCHAR(100) NOT NULL,
  brand VARCHAR(100),
  model VARCHAR(200),
  serial_no VARCHAR(200),
  status ENUM('使用中','已闲置','待出售','已出售','已丢弃') NOT NULL DEFAULT '使用中',
  purchase_id BIGINT,
  purchase_date DATE,
  enabled_date DATE,
  retired_date DATE,
  tags JSON,
  cover_image_url VARCHAR(500),
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_status (status),
  INDEX idx_cat_brand (category, brand)
);

CREATE TABLE purchase (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  asset_id BIGINT NOT NULL,
  type ENUM('PRIMARY','ACCESSORY','SERVICE') NOT NULL,
  platform VARCHAR(100),
  seller VARCHAR(200),
  price DECIMAL(12,2) NOT NULL,
  currency VARCHAR(10) DEFAULT 'CNY',
  quantity INT DEFAULT 1,
  shipping_cost DECIMAL(12,2) DEFAULT 0,
  purchase_date DATE NOT NULL,
  invoice_no VARCHAR(100),
  warranty_months INT,
  warranty_expire_date DATE,
  attachments JSON,
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_asset (asset_id),
  CONSTRAINT fk_purchase_asset FOREIGN KEY (asset_id) REFERENCES device_asset(id)
);

CREATE TABLE sale (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  asset_id BIGINT NOT NULL,
  platform VARCHAR(100),
  buyer VARCHAR(200),
  sale_price DECIMAL(12,2) NOT NULL,
  fee DECIMAL(12,2) DEFAULT 0,
  shipping_cost DECIMAL(12,2) DEFAULT 0,
  other_cost DECIMAL(12,2) DEFAULT 0,
  net_income DECIMAL(12,2),
  sale_date DATE NOT NULL,
  attachments JSON,
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_asset (asset_id),
  CONSTRAINT fk_sale_asset FOREIGN KEY (asset_id) REFERENCES device_asset(id)
);

CREATE TABLE op_log (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  biz_type VARCHAR(50) NOT NULL,        -- ASSET/PURCHASE/SALE/SETTING
  biz_id BIGINT,
  action VARCHAR(50) NOT NULL,          -- CREATE/UPDATE/DELETE/STATUS_CHANGE/SELL/ROLLBACK
  content JSON,
  operator VARCHAR(100) DEFAULT 'system',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_biz (biz_type, biz_id)
);
```

> 说明：
>
> * `sys_setting` 保存系统级参数（如 `annual_rate`）。
> * `device_asset.purchase_id`/`purchase_date` 为冗余字段，便于列表查询与排序。
> * `sale.net_income` 可由触发器或业务层写入：
>
> ```sql
> CREATE TRIGGER trg_sale_net_income_bi
> BEFORE INSERT ON sale
> FOR EACH ROW
>   SET NEW.net_income = NEW.sale_price - NEW.fee - NEW.shipping_cost - NEW.other_cost;
> ```

### 4.2 扩展与约束

* 删除资产需限制：存在购买/销售时不允许硬删（后续可加软删）。
* 日期校验：`enabled_date ≥ purchase_date`；`sale_date ≥ enabled_date`；`retired_date ≥ enabled_date`。

### 4.3 心愿单（独立表）

```sql
CREATE TABLE wishlist (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(200) NOT NULL,
  category VARCHAR(100),
  brand VARCHAR(100),
  model VARCHAR(200),
  expected_price DECIMAL(12,2),
  planned_platform VARCHAR(100),
  link VARCHAR(500),
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  converted_asset_id BIGINT NULL  -- 若已购买可关联生成的资产ID
);
```

### 4.4 字典/配置表

```sql
CREATE TABLE dict_category (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) UNIQUE NOT NULL,
  sort INT DEFAULT 0
);
CREATE TABLE dict_platform (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) UNIQUE NOT NULL,
  link VARCHAR(255),
  sort INT DEFAULT 0
);
```

---

## 5. API 设计（REST）

### 5.0 返回体与通用规范

* 成功：`{ code: 200, data: <payload>, msg: 'success' }`
* 失败：`{ code: <4xx/5xx>, data: null, msg: '<错误描述>' }`
* 分页：`page`（1 起）、`size`；返回 `{ list, total, page, size }`
* 时间：ISO8601；DB 使用 `DATE/DATETIME`。

### 5.1 系统设置

* `GET /api/settings` → `{ currency, storage_* }`
* `PUT /api/settings` → body: `{ currency?, storage_provider?, storage_endpoint?, storage_region?, storage_bucket?, storage_access_key?, storage_secret_key?, storage_base_url? }`

### 5.2 文件上传（对象存储）

* `POST /api/files/upload` （multipart）→ 返回 `{ url, objectKey }`
* `DELETE /api/files/{objectKey}` → 删除对象（可选）

> 说明：后端适配 MinIO / S3 兼容协议；URL 使用 `storage_base_url + objectKey` 拼接。

### 5.3 资产

* `POST /api/assets`：创建资产（含主购买）
* `GET /api/assets`：查询，参数：`status?（使用中|已闲置|待出售|已出售|已丢弃） category? brand? platform? tag? q? year? page? size? sort?`
* `GET /api/assets/{id}`：详情（附 metrics：`total_invest/use_days/avg_cost_per_day`）
* `PUT /api/assets/{id}`：更新
* `PATCH /api/assets/{id}/status`：`{ status }`
* `DELETE /api/assets/{id}`：限制删除

### 5.4 购买记录

* `POST /api/purchases`、`PUT /api/purchases/{id}`、`DELETE /api/purchases/{id}`
* `PATCH /api/assets/{id}/primary-purchase`：切换主购买

### 5.5 售出记录

* `POST /api/sales`（写入后置资产状态为 **已出售**）
* `PUT /api/sales/{id}`、`DELETE /api/sales/{id}`（撤销后资产状态回滚至原状态，默认回 `待出售` 或 `已闲置`）
* **便捷接口（向导）**：`POST /api/assets/{id}/sell` → 一次性完成售出（参数同 `SaleCreateReq`），并将资产状态从 `待出售` → `已出售`。

**SaleCreateReq（请求体）**

```json
{
  "platform": "闲鱼",
  "buyer": "张三",
  "sale_price": 5200.00,
  "fee": 50.00,
  "shipping_cost": 12.00,
  "other_cost": 0.00,
  "sale_date": "2025-03-08",
  "attachments": ["oss://.../screenshot1.png"],
  "notes": "95新，含原装配件"
}
```

> 校验：`sale_price >= 0`，各费用 `>= 0`；`sale_date >= enabled_date`；资产当前状态需为 `待出售` 或 `已闲置/使用中`（允许直接售出则自动置 `待出售` 再 `已出售`）。

### 5.6 心愿单（独立）

* `POST /api/wishlist`：新增心愿条目（仅基础信息）
* `GET /api/wishlist`：列表/查询
* `PUT /api/wishlist/{id}`、`DELETE /api/wishlist/{id}`
* `POST /api/wishlist/{id}/convert`：将心愿条目**转为资产**（生成资产并回写 `converted_asset_id`），前端入口为“以后买/已买”
* `POST /api/wishlist`：新增心愿条目（仅基础信息）
* `GET /api/wishlist`：列表/查询
* `PUT /api/wishlist/{id}`、`DELETE /api/wishlist/{id}`
* `POST /api/wishlist/{id}/convert`：将心愿条目**转为资产**（生成资产并回写 `converted_asset_id`），前端入口为“以后买/已买”

### 5.7 统计

* `GET /api/metrics/overview`：在用资产数、总投入、当年投入、近30天购买/售出
* `GET /api/metrics/by-category`
* `GET /api/metrics/by-platform`

### 5.8 错误码（总览）

* `200` 成功
* `400` 参数错误
* `404` 不存在
* `409` 业务冲突
* `413` 文件过大（上传）
* `415` 不支持的媒体类型（上传）
* `500` 服务器错误

#### 5.8.1 错误码字典（细化）

| code | 场景                     | 说明                                |
| ---- | ---------------------- | --------------------------------- |
| 200  | SUCCESS                | 正常                                |
| 400  | VALIDATION_ERROR       | 字段校验失败（见前端校验清单）                   |
| 404  | ASSET_NOT_FOUND        | 资产不存在                             |
| 404  | PURCHASE_NOT_FOUND     | 购买记录不存在                           |
| 404  | SALE_NOT_FOUND         | 售出记录不存在                           |
| 409  | ASSET_DELETE_CONFLICT  | 资产存在购买/售出，禁止删除                    |
| 409  | SALE_STATUS_CONFLICT   | 资产状态与售出流程不一致（如非“待出售”却创建 sale）     |
| 409  | DATE_RANGE_CONFLICT    | 日期不合法（sale_date < enabled_date 等） |
| 413  | FILE_TOO_LARGE         | 图片超出限制（默认 5MB）                    |
| 415  | UNSUPPORTED_MEDIA_TYPE | 非法图片类型（仅 jpg/png/webp）            |
| 500  | INTERNAL_ERROR         | 服务器错误                             |

---

## 6. 计算与服务层细则

### 6.1 Metrics 计算（简化）

1. 汇总 `purchase` 得出 `total_invest`。
2. 计算 `use_days`（依据当前状态的日期边界）。
3. 输出 `avg_cost_per_day = total_invest / max(use_days,1)`。

### 6.2 数据一致性

* `sale` 写入/撤销与资产状态的联动。
* 心愿单与资产互斥：心愿条目 `convert` 后标记 `converted_asset_id`，避免重复生成。

---

## 7. 后端工程设计

### 7.1 包结构（建议）

```
com.digiledger
├─ common
│  ├─ api   (统一返回体、异常处理、错误码)
│  ├─ util  (Date, Money, Validator)
├─ config   (MyBatis、Jackson、CORS、Swagger)
├─ domain
│  ├─ entity (PO: Asset, Purchase, Sale, Setting, OpLog)
│  ├─ dto    (请求/响应 DTO：AssetCreateReq, AssetDetailResp ...)
│  ├─ vo     (列表/详情 VO)
├─ mapper   (MyBatis Mapper 接口 + XML)
├─ service  (接口与实现)
├─ controller (REST)
└─ bootstrap (启动类)
```

### 7.2 统一返回体

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class ApiResp<T> {
  private int code;   // 200 success
  private T data;
  private String msg;
  public static <T> ApiResp<T> ok(T data){return new ApiResp<>(200, data, "success");}
  public static <T> ApiResp<T> fail(int code,String msg){return new ApiResp<>(code,null,msg);}  
}
```

### 7.3 关键 DTO（简要）

* `AssetCreateReq`：含 `purchase` 内嵌对象；服务层落表时需事务。
* `AssetDetailResp`：`asset + purchases + sale + metrics`。
* `SaleCreateReq`：写入后变更 `asset.status`。

### 7.4 MyBatis 建议

* MapperXML 中编写分页查询（`LIMIT #{offset}, #{size}`）。
* 公共拦截器（可选）：统一填充 `created_at/updated_at`。

### 7.5 校验规则

* 使用 `Hibernate Validator`：金额非负、日期关系合法、枚举校验。

### 7.6 Swagger/OpenAPI

* 集成 `springdoc-openapi`，暴露 `/swagger-ui.html`。

---

## 8. 前端工程设计（Vue3 + Vite + Element Plus + H5 适配）

### 8.1 菜单与导航

* **主页**：KPI 概览（资产数量、总投入、当年投入、近30天趋势）+ 快速筛选
* **物品列表**：资产查询/增删改查，支持状态/分类/平台/标签过滤
* **心愿单**：独立列表；条目带“以后买/已买”按钮 → 触发 `convert`
* **已售出列表**：

  * 页面聚合**待出售**与**已出售**两类卡片区
  * 每条 **待出售** 支持“一键出售向导”：弹出表单（售价/平台/费用/日期/买家/备注/附件上传） → 成功后移入“已出售”区
* **系统设置**：类别/购买地点字典管理；对象存储配置（MinIO/OSS）

#### 8.1.1 一键出售向导（前端交互）

* 入口：已售出列表页中的 `待出售` 卡片按钮 `去出售`
* 表单字段：`platform, buyer, sale_price, fee, shipping_cost, other_cost, sale_date, notes, attachments`
* 校验：

  * `sale_price` 必填且 `>= 0`
  * 费用类 `>= 0`
  * `sale_date` 不能早于资产 `enabled_date`
* 提交：调用 `POST /api/assets/{id}/sell`
* 回显：成功后，当前卡片从“待出售”区移入“已出售”区，显示 `net_income = sale_price - fee - shipping_cost - other_cost`

### 8.2 目录建议

```
src
├─ api        // asset.ts, purchase.ts, sale.ts, metrics.ts, setting.ts, file.ts, wishlist.ts
├─ router
├─ pages
│  ├─ dashboard/index.vue
│  ├─ asset/{list.vue, form.vue, detail.vue}
│  ├─ wishlist/{list.vue, form.vue}
│  ├─ sold/index.vue
│  └─ setting/{dict.vue, storage.vue}
├─ components // UploadBox(对象存储直传/后端转发)、StatCard、SearchBar
├─ styles     // 数码风格主题（深色+霓虹高亮），支持 H5 响应式
└─ utils      // 日期/金额/适配器
```

### 8.3 H5 适配与数码风格

* 使用 **flex/grid** + 断点（xs/sm/md）布局；按钮与表格列在小屏收敛为抽履/卡片。
* 主题建议：深色基底、蓝紫霓虹高亮、数字化卡片（适合数码产品管理）。
* 上传组件：移动端支持拍照/相册选择，自动压缩与进度提示。

### 8.4 表单字段校验清单（前端）

**资产（新建/编辑）**

* `name`：必填，1~200 字
* `category`：必填（来自字典）
* `brand`：0~100 字
* `model`：0~200 字
* `enabled_date`：必填，不能早于 `purchase_date`
* `cover_image_url`：可选，图片类型限制（jpg/png/webp）

**购买记录**

* `type`：必填，`PRIMARY/ACCESSORY/SERVICE`
* `price`：必填，`>= 0`
* `shipping_cost`：`>= 0`
* `purchase_date`：必填，`<= 今天`
* `invoice_no`：可选，0~100 字

**售出记录/出售向导**

* `sale_price`：必填，`>= 0`
* `fee / shipping_cost / other_cost`：`>= 0`
* `sale_date`：必填，`>= enabled_date`
* `platform`：推荐从字典选择，0~100 字
* `buyer`：可选，0~200 字

**心愿单**

* `name`：必填
* `expected_price`：`>= 0`
* `planned_platform`：可选，来自字典
* `link`：URL 校验（含 http/https）

**上传限制**

* 单图 ≤ 5MB；类型限 jpg/png/webp；最多 9 张/资产（可在设置里调整）。

---

## 9. 部署与环境

### 9.1 环境变量（后端）

* `DL_DB_HOST/PORT/NAME/USER/PASS`
* `DL_SERVER_PORT`（默认 `8080`）
* **对象存储**：`DL_STORAGE_PROVIDER`、`DL_STORAGE_ENDPOINT`、`DL_STORAGE_REGION`、`DL_STORAGE_BUCKET`、`DL_STORAGE_ACCESS_KEY`、`DL_STORAGE_SECRET_KEY`、`DL_STORAGE_BASE_URL`

### 9.2 Dockerfile（后端示例）

```dockerfile
FROM eclipse-temurin:21-jre
WORKDIR /app
COPY target/digiledger-backend.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java","-Duser.timezone=Asia/Shanghai","-jar","/app/app.jar"]
```

### 9.3 Dockerfile（前端示例）

```dockerfile
FROM node:22-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
```

### 9.4 Nginx 前端反代（`frontend/nginx.conf`）

```nginx
server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;

  location /api/ {
    proxy_pass http://backend:8080/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location / {
    try_files $uri $uri/ /index.html;
  }
}
```

### 9.5 docker-compose.yml（集成 MinIO）

```yaml
version: "3.9"
services:
  db:
    image: mysql:8.0
    container_name: dl-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: digiledger
      MYSQL_USER: dl_user
      MYSQL_PASSWORD: dl_pass
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./deploy/sql:/docker-entrypoint-initdb.d
    command: ["mysqld","--character-set-server=utf8mb4","--collation-server=utf8mb4_0900_ai_ci"]

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data

  backend:
    build: ./backend
    image: digiledger/backend:latest
    container_name: dl-backend
    environment:
      DL_DB_HOST: db
      DL_DB_PORT: 3306
      DL_DB_NAME: digiledger
      DL_DB_USER: dl_user
      DL_DB_PASS: dl_pass
      DL_STORAGE_PROVIDER: minio
      DL_STORAGE_ENDPOINT: http://minio:9000
      DL_STORAGE_BUCKET: digiledger
      DL_STORAGE_ACCESS_KEY: minioadmin
      DL_STORAGE_SECRET_KEY: minioadmin
      DL_STORAGE_BASE_URL: http://localhost:9000/digiledger
    depends_on:
      - db
      - minio

  frontend:
    build: ./frontend
    image: digiledger/frontend:latest
    container_name: dl-frontend
    depends_on:
      - backend
    ports:
      - "8088:80"

volumes:
  db_data:
  minio_data:
```

### 9.6 部署步骤

1. **准备目录结构**

```
DigiLedger/
├─ backend/
├─ frontend/
└─ deploy/
   └─ sql/  # init.sql, seed.sql
```

2. **后端打包**：`cd backend && mvn -DskipTests package`
3. **前端构建**：`cd frontend && npm ci && npm run build`
4. **Compose 启动**：在项目根目录执行 `docker compose up -d --build`
5. 访问前端：`http://<host>:8088`

---

## 10. 初始化 SQL（deploy/sql/init.sql 摘要）

```sql
CREATE DATABASE IF NOT EXISTS digiledger DEFAULT CHARACTER SET utf8mb4;
USE digiledger;
-- 建表（见 4. 数据模型）
-- 初始设置
INSERT INTO sys_setting (currency, storage_provider, storage_bucket) VALUES ('CNY','minio','digiledger');
```

> 可选 `seed.sql`：插入示例资产/购买/心愿条目，方便联调。

---

## 11. 统计 SQL 参考

* 总投入：

```sql
SELECT asset_id, SUM(price + shipping_cost) AS total_invest
FROM purchase
GROUP BY asset_id;
```

* 按类别投入：

```sql
SELECT a.category, SUM(p.price + p.shipping_cost) AS invest
FROM device_asset a
JOIN purchase p ON a.id = p.asset_id
GROUP BY a.category
ORDER BY invest DESC;
```

* 心愿单数量：

```sql
SELECT COUNT(*) FROM wishlist;
```

--- 统计 SQL 参考

* 总投入：

```sql
SELECT asset_id, SUM(price + shipping_cost) AS total_invest
FROM purchase
GROUP BY asset_id;
```

* 按类别投入：

```sql
SELECT a.category, SUM(p.price + p.shipping_cost) AS invest
FROM device_asset a
JOIN purchase p ON a.id = p.asset_id
GROUP BY a.category
ORDER BY invest DESC;
```

* 时间序列（按月购买额）：

```sql
SELECT DATE_FORMAT(purchase_date, '%Y-%m') AS ym, SUM(price + shipping_cost) AS invest
FROM purchase
GROUP BY ym
ORDER BY ym;
```

---

## 12. 验证与测试

### 12.1 单元测试

* 计算：`use_days`、`avg_cost_per_day`。
* 状态流转：`使用中 ↔ 已闲置 ↔ 待出售 → 已出售`；撤销恢复。
* 心愿单：`convert` 后避免重复生成资产。

### 12.2 接口契约

* Swagger/OpenAPI 字段必填与类型；分页边界；上传大小与类型限制（图片：jpg/png/webp ≤ 5MB）。

### 12.3 UI 验收（含 H5）

* 主页 KPI、趋势与快捷筛选在移动端良好展示。
* 物品列表在小屏切换为卡片流；上传图片可拍照。
* 心愿单条目“已买”→ 生成资产后，心愿列表正确标记。

---

## 13. 路线图（非 MVP）

* 多用户与权限
* 订单导入（京东/淘宝）
* 价格趋势与估值
* 通知中心（心愿降价/保修到期）
* 标签统计与可视化

--- 路线图（非 MVP）

* 账户体系（多用户/团队/权限）。
* 附件对象存储（MinIO/S3）与 CDN。
* 订单解析（京东/淘宝导入）。
* 行情估值抓取与价格快照。
* 通知（保修到期、出售提醒）。
* 使用时长模式（usage_log）与多维度成本核算。

---

### 附：示例后端配置（application.yml）

```yaml
server:
  port: ${DL_SERVER_PORT:8080}

spring:
  datasource:
    url: jdbc:mysql://${DL_DB_HOST:localhost}:${DL_DB_PORT:3306}/${DL_DB_NAME:digiledger}?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=utf8
    username: ${DL_DB_USER:root}
    password: ${DL_DB_PASS:root}
    driver-class-name: com.mysql.cj.jdbc.Driver
  jackson:
    time-zone: Asia/Shanghai

storage:
  provider: ${DL_STORAGE_PROVIDER:minio}
  endpoint: ${DL_STORAGE_ENDPOINT:http://localhost:9000}
  region: ${DL_STORAGE_REGION:}
  bucket: ${DL_STORAGE_BUCKET:digiledger}
  access-key: ${DL_STORAGE_ACCESS_KEY:}
  secret-key: ${DL_STORAGE_SECRET_KEY:}
  base-url: ${DL_STORAGE_BASE_URL:}

mybatis:
  mapper-locations: classpath:/mapper/*.xml
  configuration:
    map-underscore-to-camel-case: true

logging:
  level:
    root: INFO
    com.digiledger: DEBUG
```

### 附：前端环境变量（.env.production 示例）

```
VITE_API_BASE=/api
```

### 附：前端 Axios 实例（/src/api/http.ts）

```ts
import axios from 'axios'
const http = axios.create({ baseURL: import.meta.env.VITE_API_BASE || '/api', timeout: 15000 })
http.interceptors.response.use(
  (resp) => { const { code, data, msg } = resp.data; if (code !== 200) return Promise.reject(new Error(msg||'Error')); return data },
  (err) => Promise.reject(err)
)
export default http
```

---

## 14. 交付物与样例（OpenAPI / Postman / CSV / Seed）

> 路径建议：均位于项目根目录 `deploy/` 下，Codex 可直接读取。

### 14.1 OpenAPI 3.0 规范（`deploy/openapi.yaml`）

```yaml
openapi: 3.0.3
info:
  title: DigiLedger API
  version: 0.3.1
  description: 数码资产管理（方案A，按天均摊，不含折旧）
servers:
  - url: /api
paths:
  /settings:
    get:
      summary: 获取系统设置
      responses:
        '200': { $ref: '#/components/responses/OkSetting' }
    put:
      summary: 更新系统设置
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SettingUpdateReq' }
      responses:
        '200': { $ref: '#/components/responses/OkSetting' }
  /files/upload:
    post:
      summary: 上传图片（MinIO/S3 兼容）
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResp'
              examples:
                ok:
                  value: { code: 200, data: { url: 'http://.../digiledger/obj.png', objectKey: 'obj.png' }, msg: 'success' }
        '413': { $ref: '#/components/responses/FileTooLarge' }
        '415': { $ref: '#/components/responses/UnsupportedMedia' }
  /assets:
    get:
      summary: 查询资产
      parameters:
        - in: query; name: status; schema: { type: string, enum: [使用中, 已闲置, 待出售, 已出售, 已丢弃] }
        - in: query; name: category; schema: { type: string }
        - in: query; name: brand; schema: { type: string }
        - in: query; name: platform; schema: { type: string }
        - in: query; name: q; schema: { type: string }
        - in: query; name: page; schema: { type: integer, minimum: 1, default: 1 }
        - in: query; name: size; schema: { type: integer, minimum: 1, maximum: 200, default: 20 }
      responses:
        '200': { $ref: '#/components/responses/OkAssetPage' }
    post:
      summary: 新建资产（可内嵌主购买）
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AssetCreateReq' }
      responses:
        '200': { $ref: '#/components/responses/OkAsset' }
  /assets/{id}:
    get:
      summary: 资产详情（含 metrics）
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { $ref: '#/components/responses/OkAssetDetail' }
        '404': { $ref: '#/components/responses/NotFound' }
    put:
      summary: 更新资产
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/AssetUpdateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkAsset' }
    delete:
      summary: 删除资产（有购买/销售记录时禁止）
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { $ref: '#/components/responses/Ok' }
        '409': { $ref: '#/components/responses/Conflict' }
  /assets/{id}/status:
    patch:
      summary: 变更资产状态
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status: { type: string, enum: [使用中, 已闲置, 待出售, 已出售, 已丢弃] }
      responses:
        '200': { $ref: '#/components/responses/OkAsset' }
  /assets/{id}/sell:
    post:
      summary: 一键出售（向导接口）
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/SaleCreateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkSale' }
        '409': { $ref: '#/components/responses/Conflict' }
  /purchases:
    post:
      summary: 新建购买记录
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/PurchaseCreateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkPurchase' }
  /sales:
    post:
      summary: 新建售出记录
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/SaleCreateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkSale' }
  /wishlist:
    get:
      summary: 心愿单列表
      responses:
        '200': { $ref: '#/components/responses/OkWishlistPage' }
    post:
      summary: 新增心愿
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/WishlistCreateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkWishlist' }
  /wishlist/{id}:
    put:
      summary: 更新心愿
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/WishlistUpdateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkWishlist' }
    delete:
      summary: 删除心愿
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /wishlist/{id}/convert:
    post:
      summary: 心愿转资产
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { $ref: '#/components/responses/OkAsset' }
components:
  responses:
    Ok: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiResp' } } } }
    OkSetting: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespSetting' } } } }
    OkAsset: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespAsset' } } } }
    OkAssetDetail: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespAssetDetail' } } } }
    OkAssetPage: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespAssetPage' } } } }
    OkPurchase: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespPurchase' } } } }
    OkSale: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespSale' } } } }
    OkWishlist: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespWishlist' } } } }
    OkWishlistPage: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespWishlistPage' } } } }
    NotFound: { description: Not Found }
    Conflict: { description: Conflict }
    FileTooLarge: { description: Payload Too Large }
    UnsupportedMedia: { description: Unsupported Media Type }
  schemas:
    ApiResp:
      type: object
      properties: { code: { type: integer }, data: {}, msg: { type: string } }
      required: [code]
    ApiRespSetting: { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespAsset:   { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespAssetDetail: { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespAssetPage: { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespPurchase:{ allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespSale:    { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespWishlist:{ allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespWishlistPage:{ allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    SettingUpdateReq:
      type: object
      properties:
        currency: { type: string, example: CNY }
        storage_provider: { type: string, example: minio }
        storage_endpoint: { type: string, example: http://minio:9000 }
        storage_region: { type: string }
        storage_bucket: { type: string }
        storage_access_key: { type: string }
        storage_secret_key: { type: string }
        storage_base_url: { type: string }
    AssetCreateReq:
      type: object
      required: [name, category]
      properties:
        name: { type: string }
        category: { type: string }
        brand: { type: string }
        model: { type: string }
        enabled_date: { type: string, format: date }
        cover_image_url: { type: string }
        status: { type: string, enum: [使用中, 已闲置, 待出售, 已出售, 已丢弃] }
        purchase: { $ref: '#/components/schemas/PurchaseCreateReq' }
    AssetUpdateReq:
      type: object
      properties:
        name: { type: string }
        category: { type: string }
        brand: { type: string }
        model: { type: string }
        enabled_date: { type: string, format: date }
        cover_image_url: { type: string }
        status: { type: string, enum: [使用中, 已闲置, 待出售, 已出售, 已丢弃] }
    PurchaseCreateReq:
      type: object
      required: [asset_id, type, price, purchase_date]
      properties:
        asset_id: { type: integer }
        type: { type: string, enum: [PRIMARY, ACCESSORY, SERVICE] }
        platform: { type: string }
        seller: { type: string }
        price: { type: number, format: double }
        currency: { type: string, example: CNY }
        quantity: { type: integer, example: 1 }
        shipping_cost: { type: number, format: double, example: 0 }
        purchase_date: { type: string, format: date }
        invoice_no: { type: string }
        attachments: { type: array, items: { type: string } }
        notes: { type: string }
    SaleCreateReq:
      type: object
      required: [sale_price, sale_date]
      properties:
        platform: { type: string }
        buyer: { type: string }
        sale_price: { type: number, format: double }
        fee: { type: number, format: double, default: 0 }
        shipping_cost: { type: number, format: double, default: 0 }
        other_cost: { type: number, format: double, default: 0 }
        sale_date: { type: string, format: date }
        attachments: { type: array, items: { type: string } }
        notes: { type: string }
    WishlistCreateReq:
      type: object
      required: [name]
      properties:
        name: { type: string }
        category: { type: string }
        brand: { type: string }
        model: { type: string }
        expected_price: { type: number, format: double }
        planned_platform: { type: string }
        link: { type: string }
        notes: { type: string }
    WishlistUpdateReq:
      allOf: [ { $ref: '#/components/schemas/WishlistCreateReq' } ]
```

### 14.2 Postman 集合（`deploy/postman/DigiLedger.postman_collection.json`）

```json
{
  "info": {"name": "DigiLedger API", "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"},
  "variable": [{"key": "baseUrl", "value": "http://localhost:8080/api"}],
  "item": [
    {"name": "Settings - GET", "request": {"method": "GET", "url": "{{baseUrl}}/settings"}},
    {"name": "Upload - POST /files/upload", "request": {"method": "POST", "url": "{{baseUrl}}/files/upload","body": {"mode": "formdata","formdata": [{"key": "file","type": "file","src": "./sample.jpg"}]}}},
    {"name": "Asset - POST /assets", "request": {"method": "POST","header": [{"key":"Content-Type","value":"application/json"}],"url": "{{baseUrl}}/assets","body": {"mode": "raw","raw": "{
  \"name\": \"Sony A7M4\",
  \"category\": \"相机\",
  \"brand\": \"Sony\",
  \"enabled_date\": \"2025-01-10\",
  \"purchase\": {
    \"type\": \"PRIMARY\",
    \"platform\": \"京东\",
    \"price\": 13999,
    \"shipping_cost\": 0,
    \"purchase_date\": \"2025-01-09\"
  }
}"}}},
    {"name": "Asset - GET /assets", "request": {"method": "GET", "url": "{{baseUrl}}/assets?page=1&size=10"}},
    {"name": "Sell Wizard - POST /assets/{id}/sell", "request": {"method": "POST","header": [{"key":"Content-Type","value":"application/json"}],"url": "{{baseUrl}}/assets/1/sell","body": {"mode": "raw","raw": "{
  \"platform\": \"闲鱼\",
  \"buyer\": \"张三\",
  \"sale_price\": 11800,
  \"fee\": 80,
  \"shipping_cost\": 20,
  \"sale_date\": \"2025-03-08\"
}"}}},
    {"name": "Wishlist - POST /wishlist", "request": {"method": "POST","header": [{"key":"Content-Type","value":"application/json"}],"url": "{{baseUrl}}/wishlist","body": {"mode": "raw","raw": "{
  \"name\": \"Canon RF 85mm F1.8\",
  \"category\": \"镜头\",
  \"brand\": \"Canon\",
  \"expected_price\": 2999,
  \"planned_platform\": \"京东\",
  \"link\": \"https://item.jd.com/xxx.html\"
}"}}}
  ]
}
```

### 14.3 CSV 模板（`deploy/csv/`）

**assets.csv**

```
name,category,brand,model,enabled_date,status,cover_image_url,notes
Sony A7M4,相机,Sony,A7M4,2025-01-10,使用中,,机身+原装电池
DJI Mini 4 Pro,无人机,DJI,Mini4Pro,2024-12-11,已闲置,,用于旅行航拍
```

**purchases.csv**

```
asset_name,type,platform,seller,price,currency,quantity,shipping_cost,purchase_date,invoice_no,notes
Sony A7M4,PRIMARY,京东,京东自营,13999,CNY,1,0,2025-01-09,,首发购买
Sony A7M4,ACCESSORY,淘宝,电池店,399,CNY,1,0,2025-01-12,,原厂电池
DJI Mini 4 Pro,PRIMARY,天猫,大疆旗舰店,5999,CNY,1,12,2024-12-10,,含延保
```

**wishlist.csv**

```
name,category,brand,model,expected_price,planned_platform,link,notes
Canon RF 85mm F1.8,镜头,Canon,,2999,京东,https://item.jd.com/xxx.html,人像镜头
```

> 导入建议：先导入 `assets.csv` 生成资产，再用 `purchases.csv` 关联到已存在的 `asset_name`（后端可做名称->ID 映射或前端先查 ID）。

### 14.4 示例种子数据（`deploy/sql/seed.sql`）

```sql
USE digiledger;
-- 类别 & 平台
INSERT INTO dict_category(name,sort) VALUES ('相机',1),('镜头',2),('电池',3),('无人机',4);
INSERT INTO dict_platform(name,link,sort) VALUES ('京东','https://jd.com',1),('淘宝','https://taobao.com',2),('闲鱼','https://goofish.com',3);

-- 资产：相机主体
INSERT INTO device_asset(name,category,brand,model,status,purchase_date,enabled_date,notes)
VALUES ('Sony A7M4','相机','Sony','A7M4','使用中','2025-01-09','2025-01-10','机身+原装电池');
SET @a7m4_id = LAST_INSERT_ID();

-- 主购买 + 配件
INSERT INTO purchase(asset_id,type,platform,price,shipping_cost,purchase_date,notes)
VALUES
(@a7m4_id,'PRIMARY','京东',13999,0,'2025-01-09','首发购买'),
(@a7m4_id,'ACCESSORY','淘宝',399,0,'2025-01-12','原厂电池');

-- 资产：镜头
INSERT INTO device_asset(name,category,brand,model,status,purchase_date,enabled_date,notes)
VALUES ('Sigma 28-70 F2.8 E','镜头','Sigma','28-70/2.8','已闲置','2024-11-02','2024-11-03','便携变焦');
SET @lens_id = LAST_INSERT_ID();
INSERT INTO purchase(asset_id,type,platform,price,shipping_cost,purchase_date)
VALUES (@lens_id,'PRIMARY','淘宝',3999,12,'2024-11-02');

-- 资产：无人机
INSERT INTO device_asset(name,category,brand,model,status,purchase_date,enabled_date)
VALUES ('DJI Mini 4 Pro','无人机','DJI','Mini4Pro','待出售','2024-12-10','2024-12-11');
SET @dji_id = LAST_INSERT_ID();
INSERT INTO purchase(asset_id,type,platform,price,shipping_cost,purchase_date)
VALUES (@dji_id,'PRIMARY','天猫',5999,12,'2024-12-10');

-- 心愿单
INSERT INTO wishlist(name,category,brand,expected_price,planned_platform,link,notes)
VALUES ('Canon RF 85mm F1.8','镜头','Canon',2999,'京东','https://item.jd.com/xxx.html','人像镜头');
```

---

## 更新日志（Changelog）

* **V0.3.2（当前）**

  * 新增：`deploy/openapi.yaml`（OpenAPI 3.0.3）。
  * 新增：`deploy/postman/DigiLedger.postman_collection.json` 覆盖上传与出售向导。
  * 新增：`deploy/csv/{assets.csv,purchases.csv,wishlist.csv}` 模板与示例。
  * 新增：`deploy/sql/seed.sql`（相机主体+镜头+配件、心愿单示例）。
* **V0.3.1**

  * 错误码字典、前端字段校验清单、“一键出售向导”交互与接口。
* **V0.3**

  * 方案A 简化版（无折旧），中文状态与模块拆分，MinIO 对接等。
