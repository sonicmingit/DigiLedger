# DigiLedger V0.2 产品设计

> 约定 & 范围
>
> * 均摊成本：**按天计算**。
> * 折旧策略：**线性折旧**（支持配置年折旧率 `annual_rate`）。
> * 架构：**前后端分离**。后端 `Spring Boot + MyBatis + MySQL`；前端 `Vue3 + Vite + Element Plus`。
> * 部署：**Docker/Compose 一键启动**（含 MySQL、后端、前端、Nginx 反代）。
> * 接口返回体：统一为 `{ code, data, msg }`，`code=200` 表示成功。
> * 版本：V0.2（在 V0.1 基础上细化到可直接开发）。

---

## 1. 目标与业务概述

### 1.1 产品目标

* 管理个人/家庭/小团队的**数码资产全生命周期**：购买 → 使用 → 维护/配件 → 转售/报废。
* 实时输出**成本均摊**、**折旧**、**账面价值**、**售出盈亏**等指标。

### 1.2 关键业务要点

* **购买记录**：主购买 + 配件/服务扩展，支持附件（发票/截图）。
* **使用统计**：按天均摊；启用日期至当前/售出/报废。
* **折旧**：线性、可配置年折旧率；自动计算累计折旧与账面价值。
* **转售**：售出平台、价格、费用、净收入、盈亏自动计算；资产状态联动。
* **统计/报表**：按类别、平台、年份聚合；仪表盘 KPI。
* **导入导出**：CSV 导入资产（含主购买）、列表导出。

---

## 2. 术语与状态机

* 资产（Asset）：一台设备的主档（如：iPhone 14 Pro 256G）。
* 购买（Purchase）：资产的购买行为（主购买 / 配件 / 服务）。
* 使用（Usage）：按天均摊的前提下，可不强制记录小时级使用日志（后续再做）。
* 售出（Sale）：设备交易记录，记价格、费用、净收入、盈亏、平台等。
* 状态（Status）：`IN_USE`、`IDLE`、`FOR_SALE`、`SOLD`、`RETIRED`。

**状态机**：

* `IN_USE` ↔ `IDLE` ↔ `FOR_SALE` → `SOLD`
* 任意 → `RETIRED`（报废）
* `SOLD/RETIRED` 支持撤销（保留审计，MVP 可记录操作日志）。

---

## 3. 成本与折旧模型

### 3.1 总投入

```
总投入 total_invest = Σ( purchase.price + purchase.shipping_cost )
  其中 purchase.type ∈ { PRIMARY, ACCESSORY, SERVICE }
```

### 3.2 使用天数（按天法）

```
use_days =
  if status ∈ {IN_USE, IDLE, FOR_SALE}: days_between(enabled_date, today)
  if status = SOLD:                   days_between(enabled_date, sale_date)
  if status = RETIRED:                days_between(enabled_date, retired_date)
```

> `days_between(a,b)` 为自然日差，含首不含尾；最低为 1，避免除零。

### 3.3 平均日成本（按天均摊）

```
avg_cost_per_day = total_invest / max(use_days, 1)
```

### 3.4 线性折旧

* 参数：**年折旧率** `annual_rate`（0~1，默认 0.5 示例，可在系统设置修改）。
* 累计折旧（至**评估日** eval_date，默认 heute/售出日/报废日）：

```
accum_depr = total_invest * min( annual_rate * (use_days / 365), 1.0 )
```

* 账面价值（不低于 0）：

```
book_value = max(total_invest - accum_depr, 0)
```

### 3.5 售出指标

```
net_income    = sale_price - fee - shipping_cost - other_cost
realized_pnl  = net_income - book_value(eval_date = sale_date)
```

> `realized_pnl`：正为盈利，负为亏损。

---

## 4. 数据模型（MySQL 8）

### 4.1 表结构（DDL）

```sql
CREATE TABLE sys_setting (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  annual_rate DECIMAL(5,4) NOT NULL DEFAULT 0.5000, -- 年折旧率，默认 50%
  currency  VARCHAR(10) NOT NULL DEFAULT 'CNY',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE device_asset (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(200) NOT NULL,
  category VARCHAR(100) NOT NULL,
  brand VARCHAR(100),
  model VARCHAR(200),
  serial_no VARCHAR(200),
  status ENUM('IN_USE','IDLE','FOR_SALE','SOLD','RETIRED') NOT NULL DEFAULT 'IN_USE',
  purchase_id BIGINT,                 -- 主购买ID（冗余）
  purchase_date DATE,                 -- 主购买日期（冗余）
  enabled_date DATE,                  -- 启用日期（默认=主购买日期）
  retired_date DATE,
  tags JSON,
  cover_image_url VARCHAR(500),
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_status (status),
  INDEX idx_cat_brand (category, brand)
);

CREATE TABLE purchase (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  asset_id BIGINT NOT NULL,
  type ENUM('PRIMARY','ACCESSORY','SERVICE') NOT NULL,
  platform VARCHAR(100),
  seller VARCHAR(200),
  price DECIMAL(12,2) NOT NULL,
  currency VARCHAR(10) DEFAULT 'CNY',
  quantity INT DEFAULT 1,
  shipping_cost DECIMAL(12,2) DEFAULT 0,
  purchase_date DATE NOT NULL,
  invoice_no VARCHAR(100),
  warranty_months INT,
  warranty_expire_date DATE,
  attachments JSON,
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_asset (asset_id),
  CONSTRAINT fk_purchase_asset FOREIGN KEY (asset_id) REFERENCES device_asset(id)
);

CREATE TABLE sale (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  asset_id BIGINT NOT NULL,
  platform VARCHAR(100),
  buyer VARCHAR(200),
  sale_price DECIMAL(12,2) NOT NULL,
  fee DECIMAL(12,2) DEFAULT 0,
  shipping_cost DECIMAL(12,2) DEFAULT 0,
  other_cost DECIMAL(12,2) DEFAULT 0,
  net_income DECIMAL(12,2),
  sale_date DATE NOT NULL,
  attachments JSON,
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_asset (asset_id),
  CONSTRAINT fk_sale_asset FOREIGN KEY (asset_id) REFERENCES device_asset(id)
);

CREATE TABLE op_log (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  biz_type VARCHAR(50) NOT NULL,        -- ASSET/PURCHASE/SALE/SETTING
  biz_id BIGINT,
  action VARCHAR(50) NOT NULL,          -- CREATE/UPDATE/DELETE/STATUS_CHANGE/SELL/ROLLBACK
  content JSON,
  operator VARCHAR(100) DEFAULT 'system',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_biz (biz_type, biz_id)
);
```

> 说明：
>
> * `sys_setting` 保存系统级参数（如 `annual_rate`）。
> * `device_asset.purchase_id`/`purchase_date` 为冗余字段，便于列表查询与排序。
> * `sale.net_income` 可由触发器或业务层写入：
>
> ```sql
> CREATE TRIGGER trg_sale_net_income_bi
> BEFORE INSERT ON sale
> FOR EACH ROW
>   SET NEW.net_income = NEW.sale_price - NEW.fee - NEW.shipping_cost - NEW.other_cost;
> ```

### 4.2 基本约束

* 删除资产需级联/限制：MVP 采用**限制删除**（若存在购买/销售，不允许硬删；提供软删扩展）。
* 日期校验：`enabled_date ≥ purchase_date`；`sale_date ≥ enabled_date`；`retired_date ≥ enabled_date`。

---

## 5. API 设计（REST）

### 5.0 返回体与通用规范

* 成功：`{ code: 200, data: <payload>, msg: 'success' }`
* 失败：`{ code: <4xx/5xx>, data: null, msg: '<错误描述>' }`
* 分页：query 参数 `page`（1 起）、`size`，返回 `{ list, total, page, size }`
* 时间：ISO8601，后端持久化使用 `DATE/DATETIME`。

### 5.1 设置

* `GET /api/settings` → `{ annual_rate, currency }`
* `PUT /api/settings` → body: `{ annual_rate?, currency? }`

### 5.2 资产

* `POST /api/assets`

  * 创建资产（含主购买），请求：

  ```json
  {
    "name":"iPhone 14 Pro 256G",
    "category":"PHONE",
    "brand":"Apple",
    "model":"A2892",
    "serial_no":"",
    "enabled_date":"2024-09-15",
    "tags":["自用","摄影"],
    "notes":"",
    "purchase":{
      "type":"PRIMARY",
      "platform":"JD",
      "seller":"Apple京东自营",
      "price":8999.00,
      "shipping_cost":0,
      "purchase_date":"2024-09-10",
      "invoice_no":"JD-20240910-001",
      "warranty_months":24
    }
  }
  ```

  * 响应：`{ code:200, data:{ id }, msg:'success' }`

* `GET /api/assets`

  * 查询参数：`status? category? brand? platform? tag? q? year? page? size? sort?`（sort 示例：`purchase_date:desc`）
  * 响应：`{ code:200, data:{ list:[...], total, page, size }, msg:'success' }`

* `GET /api/assets/{id}`

  * 响应：

  ```json
  {
    "code":200,
    "data":{
      "asset":{...},
      "purchases":[...],
      "sale":{...} ,
      "metrics":{
        "total_invest": 9999.00,
        "use_days": 420,
        "avg_cost_per_day": 23.81,
        "annual_rate": 0.5,
        "accum_depr": 5000.00,
        "book_value": 4999.00
      }
    },
    "msg":"success"
  }
  ```

* `PUT /api/assets/{id}`（更新基本信息）

* `PATCH /api/assets/{id}/status` → `{ status }`

* `DELETE /api/assets/{id}`（限制删除：无购买/销售方可删除；否则返回 409）

### 5.3 购买记录

* `POST /api/purchases` → 追加配件/服务
* `PUT /api/purchases/{id}`
* `DELETE /api/purchases/{id}`（若删除主购买，需另行指定新的主购买或阻止）
* `PATCH /api/assets/{id}/primary-purchase` → `{ purchase_id }`（切换主购买）

### 5.4 售出记录

* `POST /api/sales`

  * body：`{ asset_id, platform, sale_price, fee?, shipping_cost?, other_cost?, sale_date, notes?, attachments? }`
  * 逻辑：写入 sale → 置 `asset.status = 'SOLD'`。
* `PUT /api/sales/{id}`
* `DELETE /api/sales/{id}`（撤销售出 → `asset.status` 回滚至撤销前状态，默认回 `FOR_SALE` 或 `IDLE`）

### 5.5 统计

* `GET /api/metrics/overview` → KPI（在用资产、总投入、当年投入、已回收、近30天购买/售出）
* `GET /api/metrics/by-category`
* `GET /api/metrics/by-platform`
* `GET /api/metrics/time-series?from=YYYY-MM&to=YYYY-MM&granularity=month`

### 5.6 错误码（示例）

* `200` 成功
* `400` 参数错误（含日期矛盾、金额为负等）
* `404` 资源不存在
* `409` 业务冲突（如：存在销售记录，不允许删除资产）
* `500` 服务器内部错误

---

### 5.x 心愿状态与附属品关系（新增）

* 每个资产增加**心愿状态 wish_status**：

  * VERY_SATISFIED（非常满意，长期持有）
  * SATISFIED（满意，正常使用）
  * NEUTRAL（中性，看情况）
  * WANT_TO_SELL（想卖，进入待出售列表）
  * MUST_SELL（必须出售，进入“急售/清单”）

* UI：在资产列表中以颜色标签显示。

* 详情页可修改，支持写备注说明。

* **附属品关系 related_assets**：一个资产可关联多个其他资产（如：相机主体 + 镜头 + 电池 + 云台）。

* 存储方式：`related_assets` 字段存储 JSON 数组，元素为 asset_id。

* 前端展示：

  * 详情页增加「相关设备」模块，点击可跳转。
  * 创建/编辑资产时可选择关联已有资产。

## 6. 计算与服务层细则

### 6.1 Metrics 计算流程（资产详情）

1. 读取 `sys_setting.annual_rate`、资产 `status`、日期边界（`enabled_date`~`eval_date`）。
2. 汇总 `purchase` 得到 `total_invest`。
3. 计算 `use_days` → `avg_cost_per_day`。
4. 线性折旧：`accum_depr` 与 `book_value`。
5. 若存在 `sale`：同步返回 `net_income`、`realized_pnl`。

### 6.2 数据一致性

* `sale` 写入/更新时写 `net_income`（触发器或服务层）。
* `asset.status` 与 `sale` 的存在性需互斥校验：

  * 有 `sale` → `status=SOLD`
  * 删除 `sale` → `status` 回滚。

---

## 7. 后端工程设计

### 7.1 包结构（建议）

```
com.digiledger
├─ common
│  ├─ api   (统一返回体、异常处理、错误码)
│  ├─ util  (Date, Money, Validator)
├─ config   (MyBatis、Jackson、CORS、Swagger)
├─ domain
│  ├─ entity (PO: Asset, Purchase, Sale, Setting, OpLog)
│  ├─ dto    (请求/响应 DTO：AssetCreateReq, AssetDetailResp ...)
│  ├─ vo     (列表/详情 VO)
├─ mapper   (MyBatis Mapper 接口 + XML)
├─ service  (接口与实现)
├─ controller (REST)
└─ bootstrap (启动类)
```

### 7.2 统一返回体

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class ApiResp<T> {
  private int code;   // 200 success
  private T data;
  private String msg;
  public static <T> ApiResp<T> ok(T data){return new ApiResp<>(200, data, "success");}
  public static <T> ApiResp<T> fail(int code,String msg){return new ApiResp<>(code,null,msg);}  
}
```

### 7.3 关键 DTO（简要）

* `AssetCreateReq`：含 `purchase` 内嵌对象；服务层落表时需事务。
* `AssetDetailResp`：`asset + purchases + sale + metrics`。
* `SaleCreateReq`：写入后变更 `asset.status`。

### 7.4 MyBatis 建议

* MapperXML 中编写分页查询（`LIMIT #{offset}, #{size}`）。
* 公共拦截器（可选）：统一填充 `created_at/updated_at`。

### 7.5 校验规则

* 使用 `Hibernate Validator`：金额非负、日期关系合法、枚举校验。

### 7.6 Swagger/OpenAPI

* 集成 `springdoc-openapi`，暴露 `/swagger-ui.html`。

---

## 8. 前端工程设计（Vue3 + Vite + Element Plus）

### 8.1 目录建议

```
src
├─ api        // axios 实例 + 模块：asset.ts, purchase.ts, sale.ts, metrics.ts, setting.ts
├─ router     // 路由配置
├─ pages
│  ├─ dashboard
│  ├─ asset
│  │  ├─ list.vue
│  │  ├─ form.vue           // 新建/编辑（含主购买）
│  │  └─ detail.vue         // 详情（购买/售出/指标卡片）
│  ├─ sale
│  │  └─ wizard.vue         // 售出向导
│  └─ setting
│     └─ index.vue
├─ components // 通用组件：SearchBar、StatCard、UploadBox、DictSelect
├─ utils      // 日期/金额/格式化
├─ store      // pinia（可选）
└─ styles
```

### 8.2 表单与校验

* 资产必填：`name/category/purchase.purchase_date/purchase.price`。
* 日期控件：购买日期、启用日期、售出日期。
* 金额输入：两位小数，≥ 0。

### 8.3 交互要点

* 资产列表：

  * 快速过滤（状态/类别/品牌/年份/平台/标签）。
  * 列显示：封面、名称、品牌/型号、状态、主购买价、使用天数、平均日成本、账面价值。
* 详情页：

  * 指标卡：`total_invest / use_days / avg_cost_per_day / annual_rate / accum_depr / book_value`。
  * 售出信息存在时同时显示 `net_income / realized_pnl`。
* 设置页：

  * 年折旧率即时生效（前端提示影响指标计算）。

---

## 9. 部署与环境

### 9.1 环境变量（后端）

* `DL_DB_HOST`（默认 `db`）
* `DL_DB_PORT`（默认 `3306`）
* `DL_DB_NAME`（默认 `digiledger`）
* `DL_DB_USER`（默认 `dl_user`）
* `DL_DB_PASS`（默认 `dl_pass`）
* `DL_SERVER_PORT`（默认 `8080`）
* `DL_ANNUAL_RATE`（可选，覆盖 DB 设置初值）

### 9.2 Dockerfile（后端示例）

```dockerfile
# backend/Dockerfile
FROM eclipse-temurin:21-jre
WORKDIR /app
COPY target/digiledger-backend.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java","-Duser.timezone=Asia/Shanghai","-jar","/app/app.jar"]
```

### 9.3 Dockerfile（前端示例）

```dockerfile
# frontend/Dockerfile
FROM node:22-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
```

### 9.4 Nginx 前端反代（`frontend/nginx.conf`）

```nginx
server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;

  location /api/ {
    proxy_pass http://backend:8080/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location / {
    try_files $uri $uri/ /index.html;
  }
}
```

### 9.5 docker-compose.yml

```yaml
version: "3.9"
services:
  db:
    image: mysql:8.0
    container_name: dl-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: digiledger
      MYSQL_USER: dl_user
      MYSQL_PASSWORD: dl_pass
    ports:
      - "3307:3306"   # 如需对外暴露
    volumes:
      - db_data:/var/lib/mysql
      - ./deploy/sql:/docker-entrypoint-initdb.d  # 初始化建表与种子数据
    command: ["mysqld","--character-set-server=utf8mb4","--collation-server=utf8mb4_0900_ai_ci"]

  backend:
    build: ./backend
    image: digiledger/backend:latest
    container_name: dl-backend
    environment:
      DL_DB_HOST: db
      DL_DB_PORT: 3306
      DL_DB_NAME: digiledger
      DL_DB_USER: dl_user
      DL_DB_PASS: dl_pass
      DL_SERVER_PORT: 8080
    depends_on:
      - db

  frontend:
    build: ./frontend
    image: digiledger/frontend:latest
    container_name: dl-frontend
    depends_on:
      - backend
    ports:
      - "8088:80"

volumes:
  db_data:
```

### 9.6 部署步骤

1. **准备目录结构**

```
DigiLedger/
├─ backend/
├─ frontend/
└─ deploy/
   └─ sql/  # init.sql, seed.sql
```

2. **后端打包**：`cd backend && mvn -DskipTests package`
3. **前端构建**：`cd frontend && npm ci && npm run build`
4. **Compose 启动**：在项目根目录执行 `docker compose up -d --build`
5. 访问前端：`http://<host>:8088`

---

## 10. 初始化 SQL（deploy/sql/init.sql 摘要）

```sql
-- 建库与表
CREATE DATABASE IF NOT EXISTS digiledger DEFAULT CHARACTER SET utf8mb4;
USE digiledger;
-- 建表（见 4.1 DDL）
-- 初始设置
INSERT INTO sys_setting (annual_rate, currency) VALUES (0.50, 'CNY');
```

> 可选 `seed.sql`：插入示例资产/购买/售出数据，方便联调页面与统计。

---

## 11. 统计 SQL 参考

* 总投入：

```sql
SELECT asset_id, SUM(price + shipping_cost) AS total_invest
FROM purchase
GROUP BY asset_id;
```

* 按类别投入：

```sql
SELECT a.category, SUM(p.price + p.shipping_cost) AS invest
FROM device_asset a
JOIN purchase p ON a.id = p.asset_id
GROUP BY a.category
ORDER BY invest DESC;
```

* 时间序列（按月购买额）：

```sql
SELECT DATE_FORMAT(purchase_date, '%Y-%m') AS ym, SUM(price + shipping_cost) AS invest
FROM purchase
GROUP BY ym
ORDER BY ym;
```

---

## 12. 验证与测试

### 12.1 单元测试

* 计算：`use_days`、`avg_cost_per_day`、`accum_depr`、`book_value`、`net_income`、`realized_pnl`。
* 状态流转：售出后状态= `SOLD`；撤销售出回滚。

### 12.2 接口契约

* Swagger/OpenAPI 校验字段必填与类型；金额精度；分页入参边界。

### 12.3 UI 验收

* 新增资产（带主购买）→ 列表展示 → 详情指标与折旧正确。
* 新增配件/服务 → 总投入联动。
* 售出向导 → 净收入与盈亏正确、状态联动生效。

---

## 13. 路线图（非 MVP）

* 账户体系（多用户/团队/权限）。
* 附件对象存储（MinIO/S3）与 CDN。
* 订单解析（京东/淘宝导入）。
* 行情估值抓取与价格快照。
* 通知（保修到期、出售提醒）。
* 使用时长模式（usage_log）与多维度成本核算。

---

### 附：示例后端配置（application.yml）

```yaml
server:
  port: ${DL_SERVER_PORT:8080}

spring:
  datasource:
    url: jdbc:mysql://${DL_DB_HOST:localhost}:${DL_DB_PORT:3306}/${DL_DB_NAME:digiledger}?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=utf8
    username: ${DL_DB_USER:root}
    password: ${DL_DB_PASS:root}
    driver-class-name: com.mysql.cj.jdbc.Driver
  jackson:
    time-zone: Asia/Shanghai

mybatis:
  mapper-locations: classpath:/mapper/*.xml
  configuration:
    map-underscore-to-camel-case: true

logging:
  level:
    root: INFO
    com.digiledger: DEBUG
```

### 附：前端环境变量（.env.production 示例）

```
VITE_API_BASE=/api
```

### 附：前端 Axios 实例（/src/api/http.ts）

```ts
import axios from 'axios'

const http = axios.create({
  baseURL: import.meta.env.VITE_API_BASE || '/api',
  timeout: 15000
})

http.interceptors.response.use(
  (resp) => {
    const { code, data, msg } = resp.data
    if (code !== 200) return Promise.reject(new Error(msg || 'Error'))
    return data
  },
  (err) => Promise.reject(err)
)

export default http
```

> 本设计已细化到表结构、接口、计算逻辑、工程结构与 Docker 部署，可直接进入开发与搭架。后续如需，我可输出 **MyBatis Mapper XML 模板、后端实体/DTO、前端页面骨架代码** 与 **初始化种子数据**。
