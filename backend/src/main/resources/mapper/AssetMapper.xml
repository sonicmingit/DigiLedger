<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.digiledger.backend.mapper.AssetMapper">

    <resultMap id="assetResultMap" type="com.digiledger.backend.model.entity.DeviceAsset">
        <id column="id" property="id" />
        <result column="name" property="name" />
        <result column="category_id" property="categoryId" />
        <result column="category_path" property="categoryPath" />
        <result column="brand" property="brand" />
        <result column="model" property="model" />
        <result column="serial_no" property="serialNo" />
        <result column="status" property="status" />
        <result column="purchase_id" property="purchaseId" />
        <result column="purchase_date" property="purchaseDate" />
        <result column="enabled_date" property="enabledDate" />
        <result column="retired_date" property="retiredDate" />
        <result column="cover_image_url" property="coverImageUrl" />
        <result column="notes" property="notes" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <sql id="baseColumns">
        id, name, category_id, category_path, brand, model, serial_no, status,
        purchase_id, purchase_date, enabled_date, retired_date,
        cover_image_url, notes, created_at, updated_at
    </sql>

    <select id="findAll" resultMap="assetResultMap">
        SELECT <include refid="baseColumns"/>
        FROM device_asset da
        <if test="tagIds != null and tagIds.size() > 0">
            INNER JOIN (
                SELECT atm.asset_id
                FROM asset_tag_map atm
                WHERE atm.tag_id IN
                <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                    #{tagId}
                </foreach>
                GROUP BY atm.asset_id
                HAVING COUNT(DISTINCT atm.tag_id) = #{tagCount}
            ) tag_filter ON tag_filter.asset_id = da.id
        </if>
        <where>
            <if test="status != null and status != ''">
                AND da.status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                    da.name LIKE CONCAT('%', #{keyword}, '%')
                    OR da.brand LIKE CONCAT('%', #{keyword}, '%')
                    OR da.model LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            <if test="categoryId != null">
                AND (
                    da.category_id = #{categoryId}
                    <if test="categoryPathLike != null">OR da.category_path LIKE #{categoryPathLike}</if>
                    <if test="categoryPathSuffix != null">OR da.category_path LIKE #{categoryPathSuffix}</if>
                )
            </if>
            <if test="platformId != null">
                AND EXISTS (
                    SELECT 1 FROM purchase p
                    WHERE p.asset_id = da.id AND p.platform_id = #{platformId}
                )
            </if>
        </where>
        ORDER BY da.updated_at DESC
    </select>

    <select id="findById" parameterType="long" resultMap="assetResultMap">
        SELECT <include refid="baseColumns"/> FROM device_asset WHERE id = #{id}
    </select>

    <insert id="insert" parameterType="com.digiledger.backend.model.entity.DeviceAsset" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO device_asset (
            name, category_id, category_path, brand, model, serial_no, status,
            purchase_id, purchase_date, enabled_date, retired_date,
            cover_image_url, notes
        ) VALUES (
            #{name}, #{categoryId}, #{categoryPath}, #{brand}, #{model}, #{serialNo}, #{status},
            #{purchaseId}, #{purchaseDate}, #{enabledDate}, #{retiredDate},
            #{coverImageUrl}, #{notes}
        )
    </insert>

    <update id="update" parameterType="com.digiledger.backend.model.entity.DeviceAsset">
        UPDATE device_asset
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="categoryId != null">category_id = #{categoryId},</if>
            <if test="categoryPath != null">category_path = #{categoryPath},</if>
            <if test="brand != null">brand = #{brand},</if>
            <if test="model != null">model = #{model},</if>
            <if test="serialNo != null">serial_no = #{serialNo},</if>
            <if test="status != null">status = #{status},</if>
            <if test="purchaseId != null">purchase_id = #{purchaseId},</if>
            <if test="purchaseDate != null">purchase_date = #{purchaseDate},</if>
            <if test="enabledDate != null">enabled_date = #{enabledDate},</if>
            <if test="retiredDate != null">retired_date = #{retiredDate},</if>
            <if test="coverImageUrl != null">cover_image_url = #{coverImageUrl},</if>
            <if test="notes != null">notes = #{notes},</if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <delete id="delete" parameterType="long">
        DELETE FROM device_asset WHERE id = #{id}
    </delete>

    <update id="updateStatus">
        UPDATE device_asset
        SET status = #{status},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <update id="updatePrimaryInfo">
        UPDATE device_asset
        SET purchase_id = #{purchaseId},
            purchase_date = #{purchaseDate},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <select id="countByCategory" resultType="long">
        SELECT COUNT(1)
        FROM device_asset da
        WHERE (
            da.category_id = #{categoryId}
            <if test="categoryPathLike != null">OR da.category_path LIKE #{categoryPathLike}</if>
            <if test="categoryPathSuffix != null">OR da.category_path LIKE #{categoryPathSuffix}</if>
        )
    </select>

    <update id="updateCategoryPathForCategory">
        UPDATE device_asset
        SET category_path = #{categoryPath},
            updated_at = CURRENT_TIMESTAMP
        WHERE category_id = #{categoryId}
    </update>

</mapper>
