<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.digiledger.backend.mapper.SaleMapper">

    <resultMap id="saleResultMap" type="com.digiledger.backend.model.entity.Sale">
        <id column="id" property="id" />
        <result column="asset_id" property="assetId" />
        <result column="sale_scope" property="saleScope" />
        <result column="purchase_id" property="purchaseId" />
        <result column="platform_id" property="platformId" />
        <result column="platform_name" property="platformName" />
        <result column="buyer" property="buyer" />
        <result column="sale_price" property="salePrice" />
        <result column="fee" property="fee" />
        <result column="shipping_cost" property="shippingCost" />
        <result column="other_cost" property="otherCost" />
        <result column="net_income" property="netIncome" />
        <result column="sale_date" property="saleDate" />
        <result column="attachments" property="attachments" />
        <result column="notes" property="notes" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <select id="findLatestByAsset" parameterType="long" resultMap="saleResultMap">
        SELECT *
        FROM sale
        WHERE asset_id = #{assetId}
        ORDER BY sale_date DESC, id DESC
        LIMIT 1
    </select>

    <select id="findByAssetId" resultMap="saleResultMap">
        SELECT * FROM sale WHERE asset_id = #{assetId} ORDER BY sale_date DESC, id DESC
    </select>

    <select id="findById" resultMap="saleResultMap">
        SELECT * FROM sale WHERE id = #{id}
    </select>

    <select id="findByPurchaseId" resultMap="saleResultMap">
        SELECT * FROM sale WHERE purchase_id = #{purchaseId} LIMIT 1
    </select>

    <insert id="insert" parameterType="com.digiledger.backend.model.entity.Sale" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sale (
            asset_id, sale_scope, purchase_id, platform_id, platform_name, buyer, sale_price, fee, shipping_cost,
            other_cost, net_income, sale_date, attachments, notes
        ) VALUES (
            #{assetId}, #{saleScope}, #{purchaseId}, #{platformId}, #{platformName}, #{buyer}, #{salePrice}, #{fee}, #{shippingCost},
            #{otherCost}, #{netIncome}, #{saleDate}, #{attachments}, #{notes}
        )
    </insert>

    <update id="update" parameterType="com.digiledger.backend.model.entity.Sale">
        UPDATE sale
        SET sale_scope = #{saleScope},
            purchase_id = #{purchaseId},
            platform_id = #{platformId},
            platform_name = #{platformName},
            buyer = #{buyer},
            sale_price = #{salePrice},
            fee = #{fee},
            shipping_cost = #{shippingCost},
            other_cost = #{otherCost},
            net_income = #{netIncome},
            sale_date = #{saleDate},
            attachments = #{attachments},
            notes = #{notes},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <delete id="deleteByAsset" parameterType="long">
        DELETE FROM sale WHERE asset_id = #{assetId}
    </delete>

    <delete id="deleteById" parameterType="long">
        DELETE FROM sale WHERE id = #{id}
    </delete>

    <select id="countByAsset" parameterType="long" resultType="int">
        SELECT COUNT(1) FROM sale WHERE asset_id = #{assetId}
    </select>

    <select id="countByPlatform" parameterType="long" resultType="long">
        SELECT COUNT(1) FROM sale WHERE platform_id = #{platformId}
    </select>

</mapper>
