# DigiLedger V0.3.3 产品设计（方案A 简化版）

> 约定 & 范围
>
> * 均摊成本：**按天计算**。
> * 折旧：**不再计算折旧**（仅展示总投入、使用天数、日均成本）。
> * 架构：**前后端分离**。后端 `Spring Boot + MyBatis + MySQL`；前端 `Vue3 + Vite + Element Plus`。
> * 部署：**Docker/Compose 一键启动**（含 MySQL、后端、前端、Nginx 反代）。
> * 接口返回体：统一为 `{ code, data, msg }`，`code=200` 表示成功。
> * 版本：V0.2（在 V0.1 基础上细化到可直接开发）。

---

## 1. 目标与业务概述

### 0. 文案与术语规范（个人用途）

* 面向用户的**前端/界面文案**统一使用：**物品**（不使用“资产”等商业化用语）。
* 示例：物品名称、物品列表、物品状态、物品详情、物品图片。
* **后端/数据库命名**暂保持 `asset` 兼容，避免大范围重命名带来迁移成本；后续如需统一为 `item`，将提供数据迁移脚本与兼容层。

---

## 1. 目标与业务概述

### 1.1 产品目标

* 管理个人/家庭/小团队的**数码资产全生命周期**：购买 → 使用 → 维护/配件 → 转售/报废。
* 实时输出**成本均摊**（总投入、使用天数、日均成本）等简化指标。

### 1.2 关键业务要点

* **购买记录**：主购买 + 配件/服务扩展，支持附件（发票/截图）。
* **使用统计**：按天均摊；启用日期至当前/售出/报废。
* **折旧**：不计算折旧，仅展示总投入与日均成本。
* **系统设置**：统一维护物品类别（树形）、平台与标签，前端表单/筛选实时联动。
* **转售**：记录售出平台、价格、费用、净收入；资产状态联动。
* **统计/报表**：按类别、平台、年份聚合；仪表盘 KPI。
* **导入导出**：CSV 导入资产（含主购买）、列表导出。

---

## 2. 术语与状态机

* 资产（Asset，前端展示为“物品”）：一台设备的主档（如：iPhone 14 Pro 256G）。
* 购买（Purchase）：资产的购买行为（主购买 / 配件 / 服务）。
* 使用（Usage）：按天均摊的前提下，可不强制记录小时级使用日志（后续再做）。
* 售出（Sale）：设备交易记录，记价格、费用、净收入、盈亏、平台等。
* 状态（中文）：`使用中`、`已闲置`、`待出售`、`已出售`、`已丢弃`、`心愿`（心愿为单独列表）。

**状态机（资产）**：

* `使用中` ↔ `已闲置` ↔ `待出售` → `已出售`
* 任意 → `已丢弃`
* `已出售/已丢弃` 支持撤销（保留审计日志）。

**心愿单**：独立列表，不参与上述状态流转；心愿条目可一键“转为资产”。

---

## 3. 成本与均摊模型（无折旧）

### 3.1 总投入

```
总投入 total_invest = Σ( purchase.price + purchase.shipping_cost )
  其中 purchase.type ∈ { PRIMARY, ACCESSORY, SERVICE }
```

### 3.2 使用天数（按天法）

```
use_days =
  若状态 ∈ {使用中, 已闲置, 待出售}: days_between(enabled_date, today)
  若状态 = 已出售:                 days_between(enabled_date, sale_date)
  若状态 = 已丢弃:                 days_between(enabled_date, retired_date)
```

> `days_between(a,b)` 为自然日差，含首不含尾；最低为 1，避免除零。

### 3.3 平均日成本（按天均摊）

```
avg_cost_per_day = total_invest / max(use_days, 1)
```

---

## 4. 数据模型（MySQL 8）

### 4.1 表结构（DDL）

```sql
CREATE TABLE sys_setting (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  currency  VARCHAR(10) NOT NULL DEFAULT 'CNY',
  -- 对象存储配置（MinIO/OSS/S3 等兼容接口）
  storage_provider VARCHAR(32) NOT NULL DEFAULT 'minio',  -- minio,s3,aliyun,cos,qiniu,local
  storage_endpoint VARCHAR(255),
  storage_region   VARCHAR(64),
  storage_bucket   VARCHAR(128) DEFAULT 'digiledger',
  storage_access_key VARCHAR(128),
  storage_secret_key VARCHAR(128),
  storage_base_url VARCHAR(255),
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE device_asset (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(200) NOT NULL,
  category_id BIGINT,                -- 指向多级类别
  category_path VARCHAR(500),        -- 冗余：1/12/118
  brand VARCHAR(100),
  model VARCHAR(200),
  serial_no VARCHAR(200),
  status ENUM('使用中','已闲置','待出售','已出售','已丢弃') NOT NULL DEFAULT '使用中',
  purchase_id BIGINT,
  purchase_date DATE,
  enabled_date DATE,
  retired_date DATE,
  cover_image_url VARCHAR(500),
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_status (status),
  INDEX idx_cat (category_id)
);

CREATE TABLE purchase (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  asset_id BIGINT NOT NULL,
  type ENUM('PRIMARY','ACCESSORY','SERVICE') NOT NULL,
  platform_id BIGINT,                 -- 指向平台字典
  platform_name VARCHAR(100),         -- 冗余平台名便于历史展示
  seller VARCHAR(200),
  price DECIMAL(12,2) NOT NULL,
  currency VARCHAR(10) DEFAULT 'CNY',
  quantity INT DEFAULT 1,
  shipping_cost DECIMAL(12,2) DEFAULT 0,
  purchase_date DATE NOT NULL,
  invoice_no VARCHAR(100),
  warranty_months INT,
  warranty_expire_date DATE,
  attachments JSON,
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_asset (asset_id),
  CONSTRAINT fk_purchase_asset FOREIGN KEY (asset_id) REFERENCES device_asset(id)
);

CREATE TABLE sale (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  asset_id BIGINT NOT NULL,
  platform_id BIGINT,
  platform_name VARCHAR(100),
  buyer VARCHAR(200),
  sale_price DECIMAL(12,2) NOT NULL,
  fee DECIMAL(12,2) DEFAULT 0,
  shipping_cost DECIMAL(12,2) DEFAULT 0,
  other_cost DECIMAL(12,2) DEFAULT 0,
  net_income DECIMAL(12,2),
  sale_date DATE NOT NULL,
  attachments JSON,
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_asset (asset_id),
  CONSTRAINT fk_sale_asset FOREIGN KEY (asset_id) REFERENCES device_asset(id)
);

-- 日志
CREATE TABLE op_log (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  biz_type VARCHAR(50) NOT NULL,
  biz_id BIGINT,
  action VARCHAR(50) NOT NULL,
  content JSON,
  operator VARCHAR(100) DEFAULT 'system',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_biz (biz_type, biz_id)
);

-- 多级类别（树形）
CREATE TABLE dict_category (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL,
  parent_id BIGINT DEFAULT NULL,
  level INT DEFAULT 1,
  sort INT DEFAULT 0,
  UNIQUE KEY uk_cat_parent_name (parent_id, name)
);

-- 购买平台（单级）
CREATE TABLE dict_platform (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) UNIQUE NOT NULL,
  link VARCHAR(255),
  sort INT DEFAULT 0
);

-- 标签（多级）
CREATE TABLE dict_tag (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL,
  parent_id BIGINT DEFAULT NULL,
  color VARCHAR(16),
  icon VARCHAR(64),
  sort INT DEFAULT 0,
  UNIQUE KEY uk_tag_parent_name (parent_id, name)
);

-- 物品与标签关联（多对多）
CREATE TABLE asset_tag_map (
  asset_id BIGINT NOT NULL,
  tag_id BIGINT NOT NULL,
  PRIMARY KEY(asset_id, tag_id),
  INDEX idx_tag (tag_id)
);
```

### 4.2 约束与说明（更新）

* 类别：支持 **多级树形**；`device_asset.category_id` 指向叶子节点，`category_path` 冗余整条路径用于快速过滤（如 `1/12/118`）。
* 平台：以 `dict_platform` 为准，`purchase/sale` 冗余平台名便于历史展示。
* 标签：`dict_tag` 支持多级；一个物品可多选标签，通过 `asset_tag_map` 关联。
* 删除限制：存在 `purchase/sale` 或标签映射时禁止硬删物品，优先软删（后续可加）。

### 4.3 心愿单（独立表）

```sql
CREATE TABLE wishlist (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(200) NOT NULL,
  category VARCHAR(100),
  brand VARCHAR(100),
  model VARCHAR(200),
  expected_price DECIMAL(12,2),
  planned_platform VARCHAR(100),
  link VARCHAR(500),
  notes TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  converted_asset_id BIGINT NULL  -- 若已购买可关联生成的资产ID
);
```

### 4.4 字典/配置表

* `dict_category`：树形结构，字段 `parent_id/level/sort`，同名在同一父级下唯一；删除时需保证无子级与物品引用。
* `dict_platform`：平铺列表，字段 `name/link/sort`；供采购与出售平台下拉框使用。
* `dict_tag`：树形结构，附加 `color/icon` 字段用于前端展示；标签支持多选并通过 `asset_tag_map` 关联物品。
* `asset_tag_map`：物品与标签多对多关联表，主键 `(asset_id, tag_id)`，删除物品或标签时级联清理。

---

## 5. API 设计（REST）

### 5.0 通用规范

* 接口资源名仍使用 `assets`，但前端文案展示为 **物品**。
* 成功响应：`{ code: 200, data: <payload>, msg: 'success' }`；失败时 `code` 对应 4xx/5xx，`msg` 为可读错误信息。
* 分页参数统一为 `page`（1 起）与 `size`，返回 `{ list, total, page, size }`。
* 日期时间字段遵循 ISO8601；数据库使用 `DATE/DATETIME`，前端按本地时区展示。

### 5.1 系统设置与字典

* `GET /api/settings`、`PUT /api/settings`（对象存储/货币等）
* **类别（多级）**

  * `GET /api/dict/categories/tree`：树形
  * `POST /api/dict/categories`：新增 `{ name, parent_id? }`
  * `PUT /api/dict/categories/{id}`、`DELETE /api/dict/categories/{id}`
* **平台（单级）**

  * `GET /api/dict/platforms`
  * `POST /api/dict/platforms` `{ name, link?, sort? }`
  * `PUT /api/dict/platforms/{id}`、`DELETE /api/dict/platforms/{id}`
* **标签（多级）**

  * `GET /api/dict/tags/tree`
  * `POST /api/dict/tags` `{ name, parent_id?, color?, icon?, sort? }`
  * `PUT /api/dict/tags/{id}`、`DELETE /api/dict/tags/{id}`

> 物品创建/编辑使用：`category_id`（选叶子）、`platform_id`、`tag_ids[]`。查询支持 `category_id`（含子级）、`platform_id`、`tag_ids[]` 过滤。

### 5.2 文件上传（对象存储）

* `POST /api/files/upload` （multipart）→ `{ url, objectKey }`

### 5.3 物品（assets）

* `POST /api/assets`：请求体 `{ name, categoryId, brand?, model?, serialNo?, enabledDate, retiredDate?, status, tagIds?, coverImageUrl?, notes?, purchases?[] }`；当 `purchases` 存在时使用 `PurchaseRequest` 结构（见下）。
* `PUT /api/assets/{id}`：与创建相同字段，允许部分更新。
* `GET /api/assets`：查询参数 `status?、categoryId?（含子级）、platformId?、tagIds?（逗号分隔或数组）、keyword?/q?（模糊搜索名称/型号/品牌）、page?、size?`。
* `GET /api/assets/{id}`：返回基础信息、`categoryPath`、`tags[]`、`purchases[]`、`sales[]` 以及 `totalInvest/useDays/avgCostPerDay/lastNetIncome`。
* `PATCH /api/assets/{id}/status`、`DELETE /api/assets/{id}`：同旧版约束，存在购买/出售记录时禁止删除。

> 校验：`categoryId` 必须指向叶子节点；`tagIds`、`platformId` 必须存在；`enabledDate <= retiredDate?`；`purchases[].platformId` 校验存在性。

**创建示例**

```json
{
  "name": "Sony A7C II",
  "categoryId": 12,
  "brand": "Sony",
  "model": "ILCE-7CM2",
  "enabledDate": "2025-01-10",
  "tagIds": [21, 34],
  "coverImageUrl": "https://cdn.example.com/items/a7c2.png",
  "notes": "随身备机",
  "purchases": [
    {
      "type": "PRIMARY",
      "platformId": 2,
      "seller": "索尼直营店",
      "price": 12345.00,
      "shippingCost": 0,
      "currency": "CNY",
      "quantity": 1,
      "purchaseDate": "2025-01-05",
      "invoiceNo": "SN20250105"
    }
  ]
}
```

### 5.4 购买记录（purchases）

* `POST /api/purchases`、`PUT /api/purchases/{id}`：请求体 `PurchaseRequest { assetId, type, platformId?, seller?, price, currency?, quantity?, shippingCost?, purchaseDate, invoiceNo?, warrantyMonths?, warrantyExpireDate?, attachments?, notes? }`。
* `DELETE /api/purchases/{id}`：删除时同步回写物品聚合指标。
* `PATCH /api/assets/{id}/primary-purchase`：切换主购买（仍沿用原逻辑）。

> `platformId` 为空时允许录入历史线下购买；若填写则后端自动冗余 `platform_name`。

### 5.5 售出记录（sales & sell wizard）

* `POST /api/sales`、`PUT /api/sales/{id}`：请求体 `{ assetId, platformId?, buyer?, salePrice, fee?, shippingCost?, otherCost?, saleDate, attachments?, notes? }`。
* `DELETE /api/sales/{id}`：撤销出售后恢复物品原状态，重新计算净收入。
* `POST /api/assets/{id}/sell`：向导接口，等价于创建 `sale` 并更新状态为 **已出售**。

**出售示例**

```json
{
  "platformId": 3,
  "buyer": "李四",
  "salePrice": 4800.00,
  "fee": 80.00,
  "shippingCost": 12.00,
  "otherCost": 0,
  "saleDate": "2025-04-02",
  "notes": "含原包装"
}
```

### 5.6 心愿单（wishlist）

* `POST /api/wishlist`、`PUT /api/wishlist/{id}`、`DELETE /api/wishlist/{id}`：字段保持 `name/category/brand/model/expectedPrice/plannedPlatform/link/notes`。
* `GET /api/wishlist`：分页查询。
* `POST /api/wishlist/{id}/convert`：输入 `{ asset: AssetCreateRequest }`（复用 5.3 请求体），生成物品并写入 `converted_asset_id`。

### 5.7 统计（metrics）

* `GET /api/metrics/overview`：返回在用物品数、总投入、当年投入、近 30 天购买/出售数。
* `GET /api/metrics/by-category`：按 `dict_category` 聚合，支持层级。
* `GET /api/metrics/by-platform`：按 `dict_platform` 聚合采购/出售金额。

### 5.8 错误码（总览）

* `200` 成功
* `400` 参数错误
* `404` 不存在
* `409` 业务冲突
* `413` 文件过大（上传）
* `415` 不支持的媒体类型（上传）
* `500` 服务器错误

#### 5.8.1 错误码字典（细化）

| code | 场景                     | 说明                                |
| ---- | ---------------------- | --------------------------------- |
| 200  | SUCCESS                | 正常                                |
| 400  | VALIDATION_ERROR       | 字段校验失败（见前端校验清单）                   |
| 404  | ASSET_NOT_FOUND        | 资产不存在                             |
| 404  | PURCHASE_NOT_FOUND     | 购买记录不存在                           |
| 404  | SALE_NOT_FOUND         | 售出记录不存在                           |
| 409  | ASSET_DELETE_CONFLICT  | 资产存在购买/售出，禁止删除                    |
| 409  | SALE_STATUS_CONFLICT   | 资产状态与售出流程不一致（如非“待出售”却创建 sale）     |
| 409  | DATE_RANGE_CONFLICT    | 日期不合法（sale_date < enabled_date 等） |
| 413  | FILE_TOO_LARGE         | 图片超出限制（默认 5MB）                    |
| 415  | UNSUPPORTED_MEDIA_TYPE | 非法图片类型（仅 jpg/png/webp）            |
| 500  | INTERNAL_ERROR         | 服务器错误                             |

---

## 6. 计算与服务层细则

### 6.1 Metrics 计算（简化）

1. 汇总 `purchase` 得出 `total_invest`。
2. 计算 `use_days`（依据当前状态的日期边界）。
3. 输出 `avg_cost_per_day = total_invest / max(use_days,1)`。

### 6.2 数据一致性

* `sale` 写入/撤销与资产状态的联动。
* 心愿单与资产互斥：心愿条目 `convert` 后标记 `converted_asset_id`，避免重复生成。

---

## 7. 后端工程设计

### 7.1 包结构（建议）

```
com.digiledger
├─ common
│  ├─ api   (统一返回体、异常处理、错误码)
│  ├─ util  (Date, Money, Validator)
├─ config   (MyBatis、Jackson、CORS、Swagger)
├─ domain
│  ├─ entity (PO: Asset, Purchase, Sale, Setting, OpLog)
│  ├─ dto    (请求/响应 DTO：AssetCreateReq, AssetDetailResp ...)
│  ├─ vo     (列表/详情 VO)
├─ mapper   (MyBatis Mapper 接口 + XML)
├─ service  (接口与实现)
├─ controller (REST)
└─ bootstrap (启动类)
```

### 7.2 统一返回体

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class ApiResp<T> {
  private int code;   // 200 success
  private T data;
  private String msg;
  public static <T> ApiResp<T> ok(T data){return new ApiResp<>(200, data, "success");}
  public static <T> ApiResp<T> fail(int code,String msg){return new ApiResp<>(code,null,msg);}  
}
```

### 7.3 关键 DTO（简要）

* `AssetCreateReq`：包含 `categoryId/tagIds/purchases[]` 等字段，需校验叶子类别与标签 ID；服务层保存时需事务。
* `AssetDetailResp`：`asset + purchases + sale + metrics`。
* `SaleCreateReq`：写入后变更 `asset.status`。

### 7.4 MyBatis 建议

* MapperXML 中编写分页查询（`LIMIT #{offset}, #{size}`）。
* 公共拦截器（可选）：统一填充 `created_at/updated_at`。

### 7.5 校验规则

* 使用 `Hibernate Validator`：金额非负、日期关系合法、枚举校验。

### 7.6 Swagger/OpenAPI

* 集成 `springdoc-openapi`，暴露 `/swagger-ui.html`。

---

## 8. 前端工程设计（Vue3 + Vite + Element Plus + H5 适配）

### 8.1 菜单与导航

* **主页**：KPI 概览（物品数量、总投入、当年投入、近30天趋势）+ 快速筛选
* **物品列表**：查询/增删改查，支持状态/分类（多级）/平台/标签（多级）过滤
* **心愿单**：独立列表；条目带“以后买/已买”按钮 → 触发 `convert`
* **已售出列表**：

  * 页面聚合**待出售**与**已出售**两类卡片区
  * 每条 **待出售** 支持“一键出售向导”：弹出表单（售价/平台/费用/日期/买家/备注/附件上传） → 成功后移入“已出售”区
* **系统设置**：

  * **物品类别**（**多级**）：树形维护，支持排序/拖拽/禁用。示例：相机/镜头/配件/服务；镜头→定焦/变焦。
  * **购买平台**（**单级**）：名称、链接、排序。
  * **标签**（**多级/多选**）：可选颜色、图标；用于列表过滤与可视化。
  * **其他**：常用品牌维护（可选）、自定义字段（key/label/type，用于物品扩展属性）。

#### 8.1.1 一键出售向导（前端交互）

* 入口：已售出列表页中的 `待出售` 卡片按钮 `去出售`
* 表单字段：`platform_id, buyer, sale_price, fee, shipping_cost, other_cost, sale_date, notes, attachments`
* 校验：

  * `sale_price` 必填且 `>= 0`
  * 费用类 `>= 0`
  * `sale_date` 不能早于资产 `enabled_date`
* 提交：调用 `POST /api/assets/{id}/sell`
* 回显：成功后，当前卡片从“待出售”区移入“已出售”区，显示 `net_income = sale_price - fee - shipping_cost - other_cost`

### 8.2 目录建议

```
src
├─ api        // asset.ts, purchase.ts, sale.ts, metrics.ts, setting.ts, file.ts, wishlist.ts
├─ router
├─ pages
│  ├─ dashboard/index.vue
│  ├─ asset/{list.vue, form.vue, detail.vue}
│  ├─ wishlist/{list.vue, form.vue}
│  ├─ sold/index.vue
│  └─ setting/{dict.vue, storage.vue}
├─ components // UploadBox(对象存储直传/后端转发)、StatCard、SearchBar
├─ styles     // 数码风格主题（深色+霓虹高亮），支持 H5 响应式
└─ utils      // 日期/金额/适配器
```

### 8.3 H5 适配与数码风格

* 使用 **flex/grid** + 断点（xs/sm/md）布局；按钮与表格列在小屏收敛为抽履/卡片。
* 主题建议：深色基底、蓝紫霓虹高亮、数字化卡片（适合数码产品管理）。
* 上传组件：移动端支持拍照/相册选择，自动压缩与进度提示。

### 8.4 表单字段校验清单（前端）

**物品（新建/编辑）**

* `name`（物品名称）：必填，1~200 字
* `category_id`：必填（多级类别叶子）
* `brand`：0~100 字
* `model`：0~200 字
* `tag_ids[]`：多选，可空
* `enabled_date`：必填，不能早于 `purchase_date`
* `cover_image_url`：可选，图片类型限制（jpg/png/webp）

**购买记录**

* `type`：必填，`PRIMARY/ACCESSORY/SERVICE`
* `platform_id`：推荐选择（可空）
* `price`：必填，`>= 0`
* `shipping_cost`：`>= 0`
* `purchase_date`：必填，`<= 今天`

**售出记录/出售向导**

* `platform_id`：推荐选择
* `sale_price`：必填，`>= 0`
* `fee / shipping_cost / other_cost`：`>= 0`
* `sale_date`：必填，`>= enabled_date`

**心愿单**

* `name`：必填
* `expected_price`：`>= 0`
* `planned_platform`：可选
* `link`：URL 校验（http/https）

**上传限制**

* 单图 ≤ 5MB；类型限 jpg/png/webp；最多 9 张/物品（可在设置里调整）。

---

## 9. 部署与环境

### 9.1 环境变量（后端）

* `DL_DB_HOST/PORT/NAME/USER/PASS`
* `DL_SERVER_PORT`（默认 `8080`）
* **对象存储**：`DL_STORAGE_PROVIDER`、`DL_STORAGE_ENDPOINT`、`DL_STORAGE_REGION`、`DL_STORAGE_BUCKET`、`DL_STORAGE_ACCESS_KEY`、`DL_STORAGE_SECRET_KEY`、`DL_STORAGE_BASE_URL`

### 9.2 Dockerfile（后端示例）

```dockerfile
FROM eclipse-temurin:21-jre
WORKDIR /app
COPY target/digiledger-backend.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java","-Duser.timezone=Asia/Shanghai","-jar","/app/app.jar"]
```

### 9.3 Dockerfile（前端示例）

```dockerfile
FROM node:22-alpine AS build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
```

### 9.4 Nginx 前端反代（`frontend/nginx.conf`）

```nginx
server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;

  location /api/ {
    proxy_pass http://backend:8080/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location / {
    try_files $uri $uri/ /index.html;
  }
}
```

### 9.5 docker-compose.yml（集成 MinIO）

```yaml
version: "3.9"
services:
  db:
    image: mysql:8.0
    container_name: dl-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: digiledger
      MYSQL_USER: dl_user
      MYSQL_PASSWORD: dl_pass
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./deploy/sql:/docker-entrypoint-initdb.d
    command: ["mysqld","--character-set-server=utf8mb4","--collation-server=utf8mb4_0900_ai_ci"]

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data

  backend:
    build: ./backend
    image: digiledger/backend:latest
    container_name: dl-backend
    environment:
      DL_DB_HOST: db
      DL_DB_PORT: 3306
      DL_DB_NAME: digiledger
      DL_DB_USER: dl_user
      DL_DB_PASS: dl_pass
      DL_STORAGE_PROVIDER: minio
      DL_STORAGE_ENDPOINT: http://minio:9000
      DL_STORAGE_BUCKET: digiledger
      DL_STORAGE_ACCESS_KEY: minioadmin
      DL_STORAGE_SECRET_KEY: minioadmin
      DL_STORAGE_BASE_URL: http://localhost:9000/digiledger
    depends_on:
      - db
      - minio

  frontend:
    build: ./frontend
    image: digiledger/frontend:latest
    container_name: dl-frontend
    depends_on:
      - backend
    ports:
      - "8088:80"

volumes:
  db_data:
  minio_data:
```

### 9.6 部署步骤

1. **准备目录结构**

```
DigiLedger/
├─ backend/
├─ frontend/
└─ deploy/
   └─ sql/  # init.sql, seed.sql
```

2. **后端打包**：`cd backend && mvn -DskipTests package`
3. **前端构建**：`cd frontend && npm ci && npm run build`
4. **Compose 启动**：在项目根目录执行 `docker compose up -d --build`
5. 访问前端：`http://<host>:8088`

---

## 10. 初始化 SQL（deploy/sql/init.sql 摘要）

```sql
CREATE DATABASE IF NOT EXISTS digiledger DEFAULT CHARACTER SET utf8mb4;
USE digiledger;
-- 建表（见 4. 数据模型）
-- 初始设置
INSERT INTO sys_setting (currency, storage_provider, storage_bucket) VALUES ('CNY','minio','digiledger');
```

> 可选 `seed.sql`：插入示例资产/购买/心愿条目，方便联调。

---

## 11. 统计 SQL 参考

* 总投入：

```sql
SELECT asset_id, SUM(price + shipping_cost) AS total_invest
FROM purchase
GROUP BY asset_id;
```

* 按类别投入：

```sql
SELECT a.category, SUM(p.price + p.shipping_cost) AS invest
FROM device_asset a
JOIN purchase p ON a.id = p.asset_id
GROUP BY a.category
ORDER BY invest DESC;
```

* 心愿单数量：

```sql
SELECT COUNT(*) FROM wishlist;
```

--- 统计 SQL 参考

* 总投入：

```sql
SELECT asset_id, SUM(price + shipping_cost) AS total_invest
FROM purchase
GROUP BY asset_id;
```

* 按类别投入：

```sql
SELECT a.category, SUM(p.price + p.shipping_cost) AS invest
FROM device_asset a
JOIN purchase p ON a.id = p.asset_id
GROUP BY a.category
ORDER BY invest DESC;
```

* 时间序列（按月购买额）：

```sql
SELECT DATE_FORMAT(purchase_date, '%Y-%m') AS ym, SUM(price + shipping_cost) AS invest
FROM purchase
GROUP BY ym
ORDER BY ym;
```

---

## 12. 验证与测试

### 12.1 单元测试

* 计算：`use_days`、`avg_cost_per_day`。
* 状态流转：`使用中 ↔ 已闲置 ↔ 待出售 → 已出售`；撤销恢复。
* 心愿单：`convert` 后避免重复生成资产。

### 12.2 接口契约

* Swagger/OpenAPI 字段必填与类型；分页边界；上传大小与类型限制（图片：jpg/png/webp ≤ 5MB）。

### 12.3 UI 验收（含 H5）

* 主页 KPI、趋势与快捷筛选在移动端良好展示。
* 物品列表在小屏切换为卡片流；上传图片可拍照。
* 心愿单条目“已买”→ 生成资产后，心愿列表正确标记。

---

## 13. 路线图（非 MVP）

* 多用户与权限
* 订单导入（京东/淘宝）
* 价格趋势与估值
* 通知中心（心愿降价/保修到期）
* 标签统计与可视化

--- 路线图（非 MVP）

* 账户体系（多用户/团队/权限）。
* 附件对象存储（MinIO/S3）与 CDN。
* 订单解析（京东/淘宝导入）。
* 行情估值抓取与价格快照。
* 通知（保修到期、出售提醒）。
* 使用时长模式（usage_log）与多维度成本核算。

---

### 附：示例后端配置（application.yml）

```yaml
server:
  port: ${DL_SERVER_PORT:8080}

spring:
  datasource:
    url: jdbc:mysql://${DL_DB_HOST:localhost}:${DL_DB_PORT:3306}/${DL_DB_NAME:digiledger}?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=utf8
    username: ${DL_DB_USER:root}
    password: ${DL_DB_PASS:root}
    driver-class-name: com.mysql.cj.jdbc.Driver
  jackson:
    time-zone: Asia/Shanghai

storage:
  provider: ${DL_STORAGE_PROVIDER:minio}
  endpoint: ${DL_STORAGE_ENDPOINT:http://localhost:9000}
  region: ${DL_STORAGE_REGION:}
  bucket: ${DL_STORAGE_BUCKET:digiledger}
  access-key: ${DL_STORAGE_ACCESS_KEY:}
  secret-key: ${DL_STORAGE_SECRET_KEY:}
  base-url: ${DL_STORAGE_BASE_URL:}

mybatis:
  mapper-locations: classpath:/mapper/*.xml
  configuration:
    map-underscore-to-camel-case: true

logging:
  level:
    root: INFO
    com.digiledger: DEBUG
```

### 附：前端环境变量（.env.production 示例）

```
VITE_API_BASE=/api
```

### 附：前端 Axios 实例（/src/api/http.ts）

```ts
import axios from 'axios'
const http = axios.create({ baseURL: import.meta.env.VITE_API_BASE || '/api', timeout: 15000 })
http.interceptors.response.use(
  (resp) => { const { code, data, msg } = resp.data; if (code !== 200) return Promise.reject(new Error(msg||'Error')); return data },
  (err) => Promise.reject(err)
)
export default http
```

---

## 14. 交付物与样例（OpenAPI / Postman / CSV / Seed）

> 路径建议：均位于项目根目录 `deploy/` 下，Codex 可直接读取。

### 14.1 OpenAPI 3.0 规范（`deploy/openapi.yaml`）

```yaml
openapi: 3.0.3
info:
  title: DigiLedger API
  version: 0.3.1
  description: 数码资产管理（方案A，按天均摊，不含折旧）
servers:
  - url: /api
paths:
  /settings:
    get:
      summary: 获取系统设置
      responses:
        '200': { $ref: '#/components/responses/OkSetting' }
    put:
      summary: 更新系统设置
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SettingUpdateReq' }
      responses:
        '200': { $ref: '#/components/responses/OkSetting' }
  /files/upload:
    post:
      summary: 上传图片（MinIO/S3 兼容）
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResp'
              examples:
                ok:
                  value: { code: 200, data: { url: 'http://.../digiledger/obj.png', objectKey: 'obj.png' }, msg: 'success' }
        '413': { $ref: '#/components/responses/FileTooLarge' }
        '415': { $ref: '#/components/responses/UnsupportedMedia' }
  /assets:
    get:
      summary: 查询资产
      parameters:
        - in: query; name: status; schema: { type: string, enum: [使用中, 已闲置, 待出售, 已出售, 已丢弃] }
        - in: query; name: category_id; schema: { type: integer, format: int64 }
        - in: query; name: platform_id; schema: { type: integer, format: int64 }
        - in: query; name: tag_ids; schema: { type: string, example: '1,2,3' }
        - in: query; name: keyword; schema: { type: string }
        - in: query; name: q; schema: { type: string }
        - in: query; name: page; schema: { type: integer, minimum: 1, default: 1 }
        - in: query; name: size; schema: { type: integer, minimum: 1, maximum: 200, default: 20 }
      responses:
        '200': { $ref: '#/components/responses/OkAssetPage' }
    post:
      summary: 新建资产（可内嵌主购买）
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AssetCreateReq' }
      responses:
        '200': { $ref: '#/components/responses/OkAsset' }
  /assets/{id}:
    get:
      summary: 资产详情（含 metrics）
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { $ref: '#/components/responses/OkAssetDetail' }
        '404': { $ref: '#/components/responses/NotFound' }
    put:
      summary: 更新资产
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/AssetUpdateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkAsset' }
    delete:
      summary: 删除资产（有购买/销售记录时禁止）
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { $ref: '#/components/responses/Ok' }
        '409': { $ref: '#/components/responses/Conflict' }
  /assets/{id}/status:
    patch:
      summary: 变更资产状态
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status: { type: string, enum: [使用中, 已闲置, 待出售, 已出售, 已丢弃] }
      responses:
        '200': { $ref: '#/components/responses/OkAsset' }
  /assets/{id}/sell:
    post:
      summary: 一键出售（向导接口）
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/SaleCreateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkSale' }
        '409': { $ref: '#/components/responses/Conflict' }
  /purchases:
    post:
      summary: 新建购买记录
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/PurchaseRequest' } } }
      responses:
        '200': { $ref: '#/components/responses/OkPurchase' }
  /sales:
    post:
      summary: 新建售出记录
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/SaleCreateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkSale' }
  /wishlist:
    get:
      summary: 心愿单列表
      responses:
        '200': { $ref: '#/components/responses/OkWishlistPage' }
    post:
      summary: 新增心愿
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/WishlistCreateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkWishlist' }
  /wishlist/{id}:
    put:
      summary: 更新心愿
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content: { application/json: { schema: { $ref: '#/components/schemas/WishlistUpdateReq' } } }
      responses:
        '200': { $ref: '#/components/responses/OkWishlist' }
    delete:
      summary: 删除心愿
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /wishlist/{id}/convert:
    post:
      summary: 心愿转资产
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                asset: { $ref: '#/components/schemas/AssetCreateReq' }
      responses:
        '200': { $ref: '#/components/responses/OkAsset' }
components:
  responses:
    Ok: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiResp' } } } }
    OkSetting: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespSetting' } } } }
    OkAsset: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespAsset' } } } }
    OkAssetDetail: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespAssetDetail' } } } }
    OkAssetPage: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespAssetPage' } } } }
    OkPurchase: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespPurchase' } } } }
    OkSale: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespSale' } } } }
    OkWishlist: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespWishlist' } } } }
    OkWishlistPage: { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/ApiRespWishlistPage' } } } }
    NotFound: { description: Not Found }
    Conflict: { description: Conflict }
    FileTooLarge: { description: Payload Too Large }
    UnsupportedMedia: { description: Unsupported Media Type }
  schemas:
    ApiResp:
      type: object
      properties: { code: { type: integer }, data: {}, msg: { type: string } }
      required: [code]
    ApiRespSetting: { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespAsset:   { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespAssetDetail: { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespAssetPage: { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespPurchase:{ allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespSale:    { allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespWishlist:{ allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    ApiRespWishlistPage:{ allOf: [ { $ref: '#/components/schemas/ApiResp' } ] }
    SettingUpdateReq:
      type: object
      properties:
        currency: { type: string, example: CNY }
        storage_provider: { type: string, example: minio }
        storage_endpoint: { type: string, example: http://minio:9000 }
        storage_region: { type: string }
        storage_bucket: { type: string }
        storage_access_key: { type: string }
        storage_secret_key: { type: string }
        storage_base_url: { type: string }
    AssetCreateReq:
      type: object
      required: [name, categoryId, status, enabledDate]
      properties:
        name: { type: string }
        categoryId: { type: integer, format: int64 }
        brand: { type: string }
        model: { type: string }
        serialNo: { type: string }
        status: { type: string, enum: [使用中, 已闲置, 待出售, 已出售, 已丢弃] }
        purchaseDate: { type: string, format: date }
        enabledDate: { type: string, format: date }
        retiredDate: { type: string, format: date }
        coverImageUrl: { type: string }
        notes: { type: string }
        tagIds: { type: array, items: { type: integer, format: int64 } }
        purchases: { type: array, items: { $ref: '#/components/schemas/PurchaseRequest' } }
    AssetUpdateReq:
      type: object
      properties:
        name: { type: string }
        categoryId: { type: integer, format: int64 }
        brand: { type: string }
        model: { type: string }
        serialNo: { type: string }
        status: { type: string, enum: [使用中, 已闲置, 待出售, 已出售, 已丢弃] }
        purchaseDate: { type: string, format: date }
        enabledDate: { type: string, format: date }
        retiredDate: { type: string, format: date }
        coverImageUrl: { type: string }
        notes: { type: string }
        tagIds: { type: array, items: { type: integer, format: int64 } }
        purchases: { type: array, items: { $ref: '#/components/schemas/PurchaseRequest' } }
    PurchaseRequest:
      type: object
      required: [type, price, purchaseDate]
      properties:
        assetId: { type: integer, format: int64 }
        type: { type: string, enum: [PRIMARY, ACCESSORY, SERVICE] }
        platformId: { type: integer, format: int64 }
        seller: { type: string }
        price: { type: number, format: double }
        currency: { type: string, example: CNY }
        quantity: { type: integer, example: 1 }
        shippingCost: { type: number, format: double, example: 0 }
        purchaseDate: { type: string, format: date }
        invoiceNo: { type: string }
        warrantyMonths: { type: integer }
        warrantyExpireDate: { type: string, format: date }
        attachments: { type: array, items: { type: string } }
        notes: { type: string }
    SaleCreateReq:
      type: object
      required: [salePrice, saleDate]
      properties:
        assetId: { type: integer, format: int64 }
        platformId: { type: integer, format: int64 }
        buyer: { type: string }
        salePrice: { type: number, format: double }
        fee: { type: number, format: double, default: 0 }
        shippingCost: { type: number, format: double, default: 0 }
        otherCost: { type: number, format: double, default: 0 }
        saleDate: { type: string, format: date }
        attachments: { type: array, items: { type: string } }
        notes: { type: string }
    WishlistCreateReq:
      type: object
      required: [name]
      properties:
        name: { type: string }
        category: { type: string }
        brand: { type: string }
        model: { type: string }
        expected_price: { type: number, format: double }
        planned_platform: { type: string }
        link: { type: string }
        notes: { type: string }
    WishlistUpdateReq:
      allOf: [ { $ref: '#/components/schemas/WishlistCreateReq' } ]
```

### 14.2 Postman 集合（`deploy/postman/DigiLedger.postman_collection.json`）

集合基于 Postman v2.1 规范，使用 `{{baseUrl}}=http://localhost:8080/api` 变量，主要分为两组：

* **Dictionary**：包含 `GET/POST/PUT/DELETE /api/dict/categories|platforms|tags` 示例，请求体使用 `parentId/sort/color/icon` 等字段，便于直接调试树形类别、平台与标签。
* **Items**：提供 `POST /api/assets`（含 `categoryId/tagIds/purchases[].platformId` 示例）与 `GET /api/assets`（带 `categoryId/platformId/tagIds` 过滤参数）两个请求，覆盖新增物品与条件查询。

导入后即可按顺序执行：先构建类别/平台/标签 → 创建物品 → 查询验证筛选条件。

### 14.3 CSV 模板（`deploy/csv/`）

**assets.csv**

```
name,category_id,brand,model,enabled_date,status,tag_ids,cover_image_url,notes
Sony A7M4,5,Sony,ILCE-7M4,2025-01-10,使用中,"1|2",,主力机身
DJI Mini 4 Pro,8,DJI,Mini4Pro,2024-12-11,已闲置,,https://cdn.example.com/dji-mini.png,旅行航拍备用
```

> `tag_ids` 使用 `|` 分隔多个标签 ID，导入时可自行转换为数组。

**purchases.csv**

```
asset_name,type,platform_id,platform_name,seller,price,currency,quantity,shipping_cost,purchase_date,invoice_no,notes
Sony A7M4,PRIMARY,2,京东,京东自营,13999,CNY,1,0,2025-01-09,,首发购买
Sony A7M4,ACCESSORY,4,淘宝,电池店,399,CNY,1,0,2025-01-12,,原厂电池
DJI Mini 4 Pro,PRIMARY,5,天猫,大疆旗舰店,5999,CNY,1,12,2024-12-10,,含延保
```

> `platform_name` 为冗余展示文本，可与 `platform_id` 搭配使用，空值表示线下/未知平台。

**wishlist.csv**

```
name,category,brand,model,expected_price,planned_platform,link,notes
Canon RF 85mm F1.8,镜头,Canon,,2999,京东,https://item.jd.com/xxx.html,人像镜头
```

> 导入建议：先准备好 `dict_category/dict_platform/dict_tag` 编号，再导入 `assets.csv`（写入 `category_id/tag_ids`），随后导入 `purchases.csv` 关联 `platform_id` 与 `asset_name`（可在导入时做名称→ID 映射）。

### 14.4 示例种子数据（`deploy/sql/seed.sql`）

```sql
USE digiledger;

-- 树形类别 / 平台 / 标签
INSERT INTO dict_category (id, name, parent_id, level, sort) VALUES
    (1, '数码设备', NULL, 1, 10),
    (2, '电脑', 1, 2, 10),
    (3, '笔记本', 2, 3, 10),
    (4, '摄影器材', 1, 2, 20),
    (5, '相机', 4, 3, 10);
INSERT INTO dict_platform (id, name, link, sort) VALUES
    (1, 'Apple Store', 'https://www.apple.com/store', 10),
    (2, '京东', 'https://www.jd.com', 20),
    (3, '闲鱼', 'https://2.taobao.com', 30);
INSERT INTO dict_tag (id, name, parent_id, color, icon, sort) VALUES
    (1, '创作', NULL, '#6266F1', 'ri-magic-fill', 10),
    (2, '主力机', NULL, '#2EC4B6', 'ri-flashlight-fill', 20);

-- 物品 + 购买 + 标签
INSERT INTO device_asset (id, name, category_id, category_path, brand, model, serial_no, status, purchase_date, enabled_date, cover_image_url, notes)
VALUES (1, 'MacBook Pro 14', 3, '/1/2/3', 'Apple', 'M3 Pro', 'SN123456', '使用中', '2023-10-01', '2023-10-01', 'https://example.com/macbook.png', '主力剪辑设备');
INSERT INTO purchase (asset_id, type, platform_id, platform_name, seller, price, shipping_cost, purchase_date, invoice_no, attachments, notes)
VALUES (1, 'PRIMARY', 1, 'Apple Store', 'Apple', 16888.00, 0.00, '2023-10-01', 'APL-20231001', JSON_ARRAY('https://example.com/invoice-mbp.png'), '官网直营，三年 AppleCare+');
INSERT INTO asset_tag_map (asset_id, tag_id) VALUES (1, 1), (1, 2);

-- 售出样例
INSERT INTO device_asset (id, name, category_id, category_path, brand, model, serial_no, status, purchase_date, enabled_date, retired_date, notes)
VALUES (2, 'Sony A7M4', 5, '/1/4/5', 'Sony', 'ILCE-7M4', 'SN987654', '已出售', '2022-05-12', '2022-05-15', '2024-02-01', '含 24-105 G 套机');
INSERT INTO purchase (asset_id, type, platform_id, platform_name, seller, price, shipping_cost, purchase_date, notes)
VALUES (2, 'PRIMARY', 2, '京东', 'Sony 旗舰店', 16800.00, 200.00, '2022-05-12', '618 活动立减');
INSERT INTO sale (asset_id, platform_id, platform_name, buyer, sale_price, fee, shipping_cost, other_cost, net_income, sale_date, notes)
VALUES (2, 3, '闲鱼', '张三', 12000.00, 200.00, 50.00, 0.00, 11750.00, '2024-02-01', '赠送备用电池');
INSERT INTO asset_tag_map (asset_id, tag_id) VALUES (2, 1);
```


---

## 更新日志（Changelog）

* **V0.3.3（当前）**

  * 新增：**系统设置菜单**增加 *物品类别（多级）*、*购买平台（单级）*、*标签（多级）*、*常用品牌*、*自定义字段* 的数据结构与接口。
  * 数据库：新增 `dict_tag`、`asset_tag_map`；`dict_category` 支持树形（parent_id/level）；`device_asset` 改为 `category_id/category_path`。
  * API：新增 `/api/dict/categories|platforms|tags`（含树形/CRUD）；`/api/assets` 查询支持 `category_id/platform_id/tag_ids[]`。
  * 文案：前端统一使用“**物品**”表述；后端保持 `asset` 路由兼容。
* **V0.3.2**

  * 新增：OpenAPI、Postman、CSV、seed.sql。
* **V0.3.1**

  * 错误码字典、前端字段校验清单、“一键出售向导”。
* **V0.3**

  * 方案A 简化版（无折旧），中文状态与模块拆分，MinIO 对接等。
