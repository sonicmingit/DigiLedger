openapi: 3.0.3
info:
  title: DigiLedger API
  version: 0.3.4
  description: |
    DigiLedger 后端接口，统一返回体为 `{code,data,msg}`。
servers:
  - url: http://localhost/api
paths:
  /api/files/upload:
    post:
      summary: 上传文件（MinIO）
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: 上传成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseFile'
  /api/dict/brands:
    get:
      summary: 获取品牌字典列表
      responses:
        '200':
          description: 品牌列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseBrandList'
    post:
      summary: 新增品牌
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BrandCreateReq'
      responses:
        '200':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseLong'
  /api/dict/brands/{id}:
    put:
      summary: 更新品牌
      parameters:
        - $ref: '#/components/parameters/BrandId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BrandUpdateReq'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseVoid'
    delete:
      summary: 删除品牌
      parameters:
        - $ref: '#/components/parameters/BrandId'
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseVoid'
  /api/assets:
    get:
      summary: 资产列表
      parameters:
        - in: query
          name: status
          schema:
            type: string
          description: 资产状态过滤（如 USING/IDLE/TO_SELL/SOLD 等）。
        - in: query
          name: keyword
          schema:
            type: string
          description: 关键字搜索，等价于 `q`。
        - in: query
          name: view
          schema:
            type: string
            enum: [table, card]
          description: 列表视图模式，`card` 将返回卡片视图使用的扩展字段。
        - in: query
          name: category_id
          schema:
            type: integer
          description: 支持父级 + 子孙类别过滤；传父级 ID 时将自动包含所有后代类别。
        - in: query
          name: platform_id
          schema:
            type: integer
          description: 按购买平台过滤，匹配任一关联购买记录。
        - in: query
          name: brand_id
          schema:
            type: integer
          description: 按品牌过滤。
        - in: query
          name: tag_ids
          schema:
            type: array
            items:
              type: integer
          style: form
          explode: false
          description: 多个标签 ID，使用逗号分隔，需同时命中全部标签。
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
          description: 页码，从 1 开始。
        - in: query
          name: size
          schema:
            type: integer
            minimum: 1
          description: 每页数量。
      responses:
        '200':
          description: 列表返回
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseAssetSummaries'
    post:
      summary: 新建资产
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssetCreateReq'
      responses:
        '200':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseLong'
  /api/assets/{id}:
    get:
      summary: 资产详情
      parameters:
        - $ref: '#/components/parameters/AssetId'
      responses:
        '200':
          description: 详情返回
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseAssetDetail'
    put:
      summary: 更新资产
      parameters:
        - $ref: '#/components/parameters/AssetId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssetUpdateReq'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseVoid'
    delete:
      summary: 删除资产
      parameters:
        - $ref: '#/components/parameters/AssetId'
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseVoid'
  /api/assets/{id}/status:
    patch:
      summary: 修改资产状态（卡片/列表行内）
      parameters:
        - $ref: '#/components/parameters/AssetId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssetStatusReq'
      responses:
        '200':
          description: 状态更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseVoid'
  /api/assets/{id}/sell:
    post:
      summary: 出售向导
      parameters:
        - $ref: '#/components/parameters/AssetId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SellReq'
      responses:
        '200':
          description: 售出成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseSale'
  /api/purchases:
    post:
      summary: 新增购买记录（含附属品/服务）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchaseCreateReq'
      responses:
        '200':
          description: 新建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponsePurchase'
  /api/purchases/{id}:
    put:
      summary: 更新购买记录
      parameters:
        - $ref: '#/components/parameters/PurchaseId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchaseUpdateReq'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponsePurchase'
    delete:
      summary: 删除购买记录
      parameters:
        - $ref: '#/components/parameters/PurchaseId'
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseVoid'
  /api/wishlist:
    get:
      summary: 心愿单列表
      parameters:
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: ['未购买', '已购买']
          description: 按状态筛选心愿单。
      responses:
        '200':
          description: 列表返回
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseWishlistList'
    post:
      summary: 新增心愿
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WishlistReq'
      responses:
        '200':
          description: 新建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseLong'
  /api/wishlist/{id}:
    get:
      summary: 心愿详情
      parameters:
        - $ref: '#/components/parameters/WishlistId'
      responses:
        '200':
          description: 详情返回
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseWishlist'
    put:
      summary: 更新心愿
      parameters:
        - $ref: '#/components/parameters/WishlistId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WishlistReq'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseVoid'
    delete:
      summary: 删除心愿
      parameters:
        - $ref: '#/components/parameters/WishlistId'
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseVoid'
  /api/wishlist/{id}/convert:
    post:
      summary: 心愿转资产
      parameters:
        - $ref: '#/components/parameters/WishlistId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssetCreateReq'
      responses:
        '200':
          description: 转换成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponseLong'
components:
  parameters:
    AssetId:
      name: id
      in: path
      required: true
      schema:
        type: integer
      description: 资产 ID。
    WishlistId:
      name: id
      in: path
      required: true
      schema:
        type: integer
      description: 心愿 ID。
    BrandId:
      name: id
      in: path
      required: true
      schema:
        type: integer
      description: 品牌 ID。
    PurchaseId:
      name: id
      in: path
      required: true
      schema:
        type: integer
      description: 购买记录 ID。
  schemas:
    ApiResponseVoid:
      type: object
      properties:
        code:
          type: integer
        data:
          nullable: true
        msg:
          type: string
    ApiResponseLong:
      allOf:
        - $ref: '#/components/schemas/ApiResponseVoid'
      properties:
        data:
          type: integer
    ApiResponseFile:
      allOf:
        - $ref: '#/components/schemas/ApiResponseVoid'
      properties:
        data:
          type: object
          properties:
            url:
              type: string
    ApiResponseBrandList:
      allOf:
        - $ref: '#/components/schemas/ApiResponseVoid'
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Brand'
    ApiResponseAssetSummaries:
      allOf:
        - $ref: '#/components/schemas/ApiResponseVoid'
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/AssetSummary'
    ApiResponseAssetDetail:
      allOf:
        - $ref: '#/components/schemas/ApiResponseVoid'
      properties:
        data:
          $ref: '#/components/schemas/AssetDetail'
    ApiResponseSale:
      allOf:
        - $ref: '#/components/schemas/ApiResponseVoid'
      properties:
        data:
          $ref: '#/components/schemas/Sale'
    ApiResponsePurchase:
      allOf:
        - $ref: '#/components/schemas/ApiResponseVoid'
      properties:
        data:
          $ref: '#/components/schemas/Purchase'
    ApiResponseWishlistList:
      allOf:
        - $ref: '#/components/schemas/ApiResponseVoid'
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Wishlist'
    ApiResponseWishlist:
      allOf:
        - $ref: '#/components/schemas/ApiResponseVoid'
      properties:
        data:
          $ref: '#/components/schemas/Wishlist'
    Brand:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        alias:
          type: string
          nullable: true
        initial:
          type: string
          nullable: true
        sort:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    BrandCreateReq:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: 品牌名称。
        alias:
          type: string
          nullable: true
        initial:
          type: string
          nullable: true
        sort:
          type: integer
          nullable: true
    BrandUpdateReq:
      allOf:
        - $ref: '#/components/schemas/BrandCreateReq'
    AssetSummary:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        category_id:
          type: integer
        category_path:
          type: array
          items:
            type: string
        brand_id:
          type: integer
          nullable: true
        brand_name:
          type: string
          nullable: true
        status:
          type: string
        cover_image_url:
          type: string
          nullable: true
        total_invest:
          type: number
          format: double
        avg_cost_per_day:
          type: number
          format: double
        use_days:
          type: integer
        enabled_date:
          type: string
          format: date
        purchase_date:
          type: string
          format: date
          nullable: true
        tag_ids:
          type: array
          items:
            type: integer
        tag_names:
          type: array
          items:
            type: string
    AssetDetail:
      allOf:
        - $ref: '#/components/schemas/AssetSummary'
      properties:
        model:
          type: string
          nullable: true
        serial_no:
          type: string
          nullable: true
        retired_date:
          type: string
          format: date
          nullable: true
        notes:
          type: string
          nullable: true
        purchases:
          type: array
          items:
            $ref: '#/components/schemas/Purchase'
        sales:
          type: array
          items:
            $ref: '#/components/schemas/Sale'
    AssetCreateReq:
      type: object
      required: [name, category_id, status]
      properties:
        name:
          type: string
        category_id:
          type: integer
        brand_id:
          type: integer
          nullable: true
        model:
          type: string
          nullable: true
        serial_no:
          type: string
          nullable: true
        status:
          type: string
        purchase_date:
          type: string
          format: date
          description: 购买日期，将用于计算启用日期默认值。
        enabled_date:
          type: string
          format: date
          nullable: true
          description: 后端默认与 `purchase_date` 一致，无需传入时可省略。
        retired_date:
          type: string
          format: date
          nullable: true
        cover_image_url:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        tag_ids:
          type: array
          items:
            type: integer
        purchases:
          type: array
          items:
            $ref: '#/components/schemas/PurchaseInlineReq'
    AssetUpdateReq:
      allOf:
        - $ref: '#/components/schemas/AssetCreateReq'
    AssetStatusReq:
      type: object
      required: [status]
      properties:
        status:
          type: string
          description: 新的资产状态（USING/IDLE/TO_SELL/SOLD/DISCARDED 等）。
    Purchase:
      type: object
      properties:
        id:
          type: integer
        asset_id:
          type: integer
        name:
          type: string
          nullable: true
        type:
          type: string
        platform_id:
          type: integer
          nullable: true
        platform_name:
          type: string
          nullable: true
        seller:
          type: string
          nullable: true
        price:
          type: number
          format: double
        currency:
          type: string
          nullable: true
        quantity:
          type: integer
          nullable: true
        shipping_cost:
          type: number
          format: double
        purchase_date:
          type: string
          format: date
        invoice_no:
          type: string
          nullable: true
        attachments:
          type: array
          items:
            type: string
        notes:
          type: string
          nullable: true
    PurchaseBaseReq:
      type: object
      required: [type, price, purchase_date]
      properties:
        name:
          type: string
          nullable: true
          description: 配件或服务类型时必填。
        type:
          type: string
          description: PRIMARY/ACCESSORY/SERVICE 等。
        platform_id:
          type: integer
          nullable: true
        seller:
          type: string
          nullable: true
        price:
          type: number
          format: double
        currency:
          type: string
          nullable: true
        quantity:
          type: integer
          nullable: true
        shipping_cost:
          type: number
          format: double
          nullable: true
        purchase_date:
          type: string
          format: date
        invoice_no:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        attachments:
          type: array
          items:
            type: string
    PurchaseInlineReq:
      allOf:
        - $ref: '#/components/schemas/PurchaseBaseReq'
    PurchaseCreateReq:
      allOf:
        - $ref: '#/components/schemas/PurchaseBaseReq'
        - type: object
          required: [asset_id]
          properties:
            asset_id:
              type: integer
    PurchaseUpdateReq:
      $ref: '#/components/schemas/PurchaseBaseReq'
    SellReq:
      type: object
      required: [sale_price, sale_date]
      properties:
        platform:
          type: string
          nullable: true
        buyer:
          type: string
          nullable: true
        sale_price:
          type: number
          format: double
        fee:
          type: number
          format: double
          nullable: true
        shipping_cost:
          type: number
          format: double
          nullable: true
        other_cost:
          type: number
          format: double
          nullable: true
        sale_date:
          type: string
          format: date
        attachments:
          type: array
          items:
            type: string
        notes:
          type: string
          nullable: true
    Sale:
      type: object
      properties:
        id:
          type: integer
        platform:
          type: string
          nullable: true
        buyer:
          type: string
          nullable: true
        sale_price:
          type: number
          format: double
        fee:
          type: number
          format: double
        shipping_cost:
          type: number
          format: double
        other_cost:
          type: number
          format: double
        net_income:
          type: number
          format: double
        sale_date:
          type: string
          format: date
        attachments:
          type: array
          items:
            type: string
        notes:
          type: string
          nullable: true
    Wishlist:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        category_id:
          type: integer
          nullable: true
        brand_id:
          type: integer
          nullable: true
        expected_price:
          type: number
          format: double
          nullable: true
        image_url:
          type: string
          nullable: true
        status:
          type: string
          description: 未购买 或 已购买。
        notes:
          type: string
          nullable: true
        link:
          type: string
          nullable: true
        converted_asset_id:
          type: integer
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    WishlistReq:
      type: object
      required: [name]
      properties:
        name:
          type: string
        category_id:
          type: integer
          nullable: true
        brand_id:
          type: integer
          nullable: true
        expected_price:
          type: number
          format: double
          nullable: true
        image_url:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        link:
          type: string
          nullable: true
